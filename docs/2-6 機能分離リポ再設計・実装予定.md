# 2-6 機能分離リポ再設計・実装予定.md

## 26. 再始動プレイブック（確定 / 2025-10-12）

**目的**: プロジェクト再始動時に迷わず着手し、最初の 30 分で“文脈復元 → 健康チェック → 作業再開”まで到達する。

### 26.1 最初の 30 分チェックリスト（順番固定）

1. **環境宣言**（必須）

   - `env_manifest.yaml` を確認（branch/commit/mode/actor/site）
   - `scripts/run.ps1 -WhatIf` で起動前検証（依存/パス/権限）

2. **文脈復元**

   - `tools/make_context_bundle.ps1 -Load`（前回の `CTX-*.zip` を指定）
   - GPT へ `gpt_context_map.yaml` → `env_manifest.yaml` → `repo.contract.yaml` の順にアップロード

3. **健全性スモーク**（Collector 停止のまま）

   - `scripts/diag/diag_api.ps1`（IPv4 優先）
   - `ops/collector/health.ps1 -DryRun`（latest/raw 整合・閾値表示のみ）

4. **設定差分の確認**

   - `tools/diff_config.ps1`（defaults vs registry/ui/secrets）

5. **ハンドオーバー読込**

   - `handover.yaml` の `next_tasks` をダッシュボードに掲示（UI の ToDo エリア）

### 26.2 “最初のタスク”：引継ぎ資料の**自動作成**（固定）

- 再始動直後に必ず実行：`tools/make_context_bundle.ps1`（新規 `CTX-*.zip` 生成）
- 生成内容：第 25 章 25.1 の一式（`env_manifest.yaml`/`handover.yaml`/`gpt_context_map.yaml`/…）
- 監査：`audit.jsonl` に `handover.bundle.create` を記録（actor/site/session/zip_path/hash）

### 26.3 モードと安全網

- 再始動時の既定モードは **DEBUG（黄）**。Collector 起動前の確認が済んだら **PROD（緑）** に遷移。
- 失敗系が出たら **DIAG（赤）** に一時切替して根拠採取 → 速やかに緑へ戻す。

### 26.4 実行コマンド例（PowerShell）

```powershell
# 1) 起動前検証
scripts/run.ps1 -WhatIf

# 2) 前回文脈の読込（任意）
tools/make_context_bundle.ps1 -Load ./artifacts/context_bundle/CTX-2025...zip

# 3) スモーク
scripts/diag/diag_api.ps1
ops/collector/health.ps1 -DryRun

# 4) 引継ぎ資料の自動作成（必ず）
tools/make_context_bundle.ps1
```

### 27 ハンドオフ仕様（Handoff System Specification）

■ 概要

ハンドオフは、開発セッションの区切り・引き継ぎ・チャットまたぎを自動化するための軽量アーカイブ生成システムであり、
1 クリックで「再開可能な完全文脈パッケージ（Handoff_YYYYMMDD_HHMM.zip）」を生成する。

■ 目的

チャットをまたいでも開発状態を即再現できること。

リポジトリ構造・環境・作業状況を自動収集し、ノイズを排除すること。

GPT と人間の両方がシームレスに開発を継続できること。

■ 生成対象
種別 格納パス 内容
🗂 構成図 repo*structure.yaml ディレクトリ構造＋各ファイル先頭コメント 2 行。
⚙️ 環境定義 env_manifest.yaml OS / Python / Streamlit / 依存関係バージョン。
🧠 開発文脈 gpt_context_map.yaml 現在フェーズ・モード・作業中ファイル・未完タスク。
🪪 作業履歴 handover.md ライブ引継ぎログ（完了・残タスク・次回方針）。
🧰 スクリプト scripts/handoff/make_handoff.ps1 ハンドオフ生成スクリプト。
🔖 復元点 scripts/git/git_rp*\*.ps1 Git ロールバック関連スクリプト。
🧱 付随データ data_sample/, logs_sample/ データ／ログ構造のダミー。

※「開発ルール」と「構成思想（2-1〜2-6）」はプロジェクトファイル内で管理するため、ZIP からは除外。

■ 動作仕様

実行方法：

& .\scripts\handoff\make_handoff.ps1

またはルート直下の make_handoff.bat をクリック。
実行後、完了ログとともに ZIP を生成する。

内部処理フロー：

環境情報収集 → env_manifest.yaml

Git タグ・ブランチ抽出

ファイル構造走査 → repo_structure.yaml

handover.md／gpt_context_map.yaml 同梱

ZIP 化して docs/handoff/ に出力。

■ LiveHandoff 連携

Handoff ZIP 内の handover.md と gpt_context_map.yaml により、
次チャットでアップロードすると自動で開発フェーズ・モード・残タスクを復元。

GPT はこれらを解析し、「続きから開始します」と応答する。

■ 手動運用ルール
操作 コマンド 用途
日次ハンドオフ make_handoff.bat 毎日の作業終了時に実行。
復元ポイント作成 git_rp_make.ps1 大改修や節目の前に実行。
復元ポイント一覧 git_rp_list.ps1 既存 rp タグの確認。
復元 git_rp_restore.ps1 指定タグへロールバック。
■ 関連運用

ハンドオフ：日次引継ぎ（軽量）

復元ポイント：差分追跡（Git タグ）

フルバックアップ：節目や重大更新時（手動）
三層構成で安全性と再現性を両立する。

■ 今後の拡張

make_handoff.ps1 に自動 rp タグ発行を追加予定。

gpt_context_map.yaml に開発者ノート欄を追加。

LiveHandoff と CTX バンドル統合によるワンクリック完全引継ぎを最終目標とする。
