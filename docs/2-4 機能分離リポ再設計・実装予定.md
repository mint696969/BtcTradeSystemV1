# 2-4 機能分離リポ再設計・実装予定.md

## 23. 共通基盤（common/）最小構成（確定 / 2025-10-12）

**目的**: 各機能を疎結合に保ちつつ、重複実装と設計ゆらぎを防止する“薄い”共通部。**肥大化させない**ことが最重要。

### 23.1 ディレクトリ構成（短名・浅階層）

```
common/
  audit.py        # 監査イベント出力（緑/黄/赤の粒度対応）
  log.py          # 標準ログ設定（QueueHandler + 日次ローテ）
  paths.py        # 外出しパス解決（ENV優先）
  settings.py     # 設定の読込/マージ/検証（defaults→registry→ui）
  schemas.py      # 設定・データのPydanticスキーマ（最小）
  rate.py         # トークンバケット（global→group→endpoint 階層）
  http.py         # HTTPクライアント薄ラッパ（IPv4優先/Retry/Backoff）
  locks.py        # ファイルロック/ミューテックス（stale判定付）
  io_safe.py      # SafeWriter（tmp→置換、JSONL append+fsync）
  time.py         # 時刻・UTC ms・セッションID採番
  ids.py          # ハッシュ/ID生成（ingest_id, session）
  health_codes.py # 健全性・外因/内因の定数群
  errors.py       # 共通例外（RateLimitExceededError 等）
```

> これ以上の追加は“機能側(core)”で必要になってから検討。**common は最小**に保つ。

### 23.2 依存方向（固定）

```
app → core → common
```

- 逆流（common→core / common→app）は禁止。
- common は外部依存を増やさない（標準ライブラリ＋最小の型ライブラリのみ）。

### 23.3 各モジュールの役割と I/F（要点）

- **audit.py**

  - `audit(event, level="INFO", **fields)` … `logs/audit.jsonl` に 1 行出力（モード別サンプリング対応）
  - 起動時に `actor/site/session/task/mode` をセット（settings or ENV）

- **log.py**

  - `setup_logger(feature:str)` … QueueHandler + TimedRotatingFileHandler を返す

- **paths.py**

  - `data_dir(), logs_dir(), models_dir(), artifacts_dir(), secrets_dir()`
  - 参照優先：引数 → `BTC_TS_*` → 既定（リポ直下）

- **settings.py**

  - `load_app()`, `load_exchanges()` … defaults/registry/ui をマージして返す
  - `save_ui(tab, data)` … `config/ui/*.yaml` に保存

- **schemas.py**

  - `Exchange`, `Rate`, `Endpoint`, `NetPref`, `AppConfig` 等の最小 Pydantic モデル

- **rate.py**

  - `TokenBucket.acquire(scope, cost=1, timeout_ms=...)` … 待機実行。429 でディレート。
  - Registry：`from_config(exchanges_cfg)` で各スコープを構築

- **http.py**

  - `get/post` … `net_pref`（ipv4/ipv6/auto）・retry/backoff・`Retry-After`尊重・TLS 検証

- **locks.py**

  - `acquire(feature)` … `data/locks/{feature}.lock` を作成、stale 検知・解放

- **io_safe.py**

  - `write_atomic(path, bytes)` / `append_jsonl(path, obj)` / `repair_jsonl_tail(path)`

- **time.py / ids.py**

  - `utc_ms()`, `session_id()`, `ingest_id(session, seq)`

- **health_codes.py / errors.py**

  - `OK, SRC_DOWN, NET_BLOCK, AUTH_FAIL, RATE_LIMIT, DNS_FAIL, ...`
  - `ConfigError, RateLimitExceededError, LockStaleError, WriteError, ...`

### 23.4 ファイル先頭ヘッダ（2 行ルール）

- 各ファイルの先頭に：

  ```
  # path: common/<file>.py
  # desc: 役割を一言で
  ```

### 23.5 テストと診断（最小）

- `tests/common/test_io_safe.py`：アトミック書込/修復のスモーク
- `tests/common/test_rate.py`：トークンバケットの待機/429 反応
- `scripts/diag/diag_api.ps1`：http.py 経由の疎通確認（IPv4 優先）

### 23.6 将来拡張の掟

- 共通化は**3 箇所で同じ処理が生じてから**検討（早すぎる抽象化を禁止）。
- 追加時は **API を小さく**、docstring で責務境界を明記。

> 本章の I/F に合わせて features 側を実装すれば、再構築なく長期運用が可能。以後、common/ への追加要望はキャンバスで審議してから反映する。

---

## 24. ダッシュボード：監査ビュー & 健全性ビュー（仕様 / 2025-10-12）

**目的**: 異常を「原因 → 根拠 → 対処」まで最短導線で辿れる画面を提供。UI は**読み取り専用**（副作用は監査発行のみ）。

### 24.1 画面配置・ファイル（短名・2 行ヘッダ）

- `features/dash/app/ui_audit.py` … 監査ビュー（検索/フィルタ/ジャンプ）
- `features/dash/app/ui_health.py` … 健全性ビュー（カード/表/推奨アクション）
- `features/dash/core/svc_audit.py` … 監査の読取/検索/整形
- `features/dash/core/svc_health.py` … 健全性の読取/推定/整形

### 24.2 データソース

- 監査: `logs/audit.jsonl`（日次ローテあり）＋ `logs/archive/audit-YYYYMMDD.jsonl.gz`
- 健全性: `data/collector/status.json`（第一優先）、フォールバックで `data/latest/*` と `data/raw/*` の mtime

### 24.3 監査ビュー（UI 要件）

- **フィルタ**: `mode(PROD/DEBUG/DIAG)`, `feature`, `event`, `level`, `actor`, `site`, `session`, `task`, `time range`
- **検索**: フリーテキスト（payload 含む）、正規表現 ON/OFF、上限件数（既定 1000）
- **一覧列**: `ts`, `mode`, `feature`, `event`, `level`, `session`, `task`, `msg/payload`（短縮）
- **行クリックのアクション**:

  - **根拠へジャンプ**: `source_file` と `payload.path`（raw/latest/log）を表示し、クリップボードへコピー
  - **関連イベント**: 同 `session` の前後 `±N` 件をサイドパネルに表示
  - **原因分類**: `health_codes` を参照し、`外因/内因` をタグ表示

- **エクスポート**: フィルタ結果を `csv` / `jsonl` で保存（副作用なし）
- **パフォーマンス**: 検索は**日次ファイル限定**→ 必要に応じてアーカイブへ拡張検索（段階的）

### 24.4 健全性ビュー（UI 要件）

- **サマリカード**（取引所ごと）: `status(OK/WARN/CRIT/外因/内因)`, `last_ok`, `age_sec`, `retries`, `cause`, `hint`
- **一覧表**: `exchange`, `topic`, `last_iso`, `age_sec`, `status`, `source`（`status.json` or `mtime`）、`notes`
- **診断リンク**: 監査ビューへ `session` / `event` を渡して遷移
- **可視化**: 直近 `N` 分の `件数/エラー率/latency` のスパークライン（軽量）
- **推奨アクション**: `cause` ごとにテンプレ表示（例：`NET_BLOCK→FW/Proxyを確認`、`RATE_LIMIT→レート下げ`）

### 24.5 コアサービス（I/F）

- `svc_audit.search(filters, limit, archive=False) -> list[AuditRow]`
- `svc_audit.related(session, around, window) -> list[AuditRow]`
- `svc_health.read() -> HealthSummary`（`status.json` 優先）
- `svc_health.estimate_from_mtime(data_root) -> HealthSummary`（フォールバック）

### 24.6 型（抜粋 / schemas.py）

```python
class AuditRow(BaseModel):
    ts: str; mode: str; feature: str; event: str; level: str
    actor: str|None; site: str|None; session: str|None; task: str|None
    source_file: str|None; line_hint: int|None; payload: dict|None

class HealthItem(BaseModel):
    exchange: str; topic: str; status: str; last_iso: str|None
    age_sec: float|None; cause: str|None; retries: int|None
    source: str; notes: str|None

class HealthSummary(BaseModel):
    items: list[HealthItem]
    updated_at: str
```

### 24.7 監査モードとの連動（緑/黄/赤）

- 緑: 成功イベントは集計のみ表示（件数/サイズ/待機 ms）
- 黄: 成功は `1/N` サンプル、失敗は詳細
- 赤: 成功/失敗とも**詳細**、ヘッダとレスポンス断片（個人情報除去）

### 24.8 エラー・個人情報の扱い

- `payload` の機密（API 鍵・トークン・署名・住所）は**マスキング**して保存・表示
- 例外トレースはハッシュ化（`stack_hash`）を主表示、全文は展開時のみ（上限 KB）

---

### 24.9 並び順の同期（カード ⇄ グラフ）

**要件**

- カードの**ドラッグ&ドロップで順番変更**可。左 → 右の順をそのまま**グラフの上 → 下**に反映。
- 並び順はユーザー単位で保持し、再起動しても復元。

**保存先**

- `config/ui/health.yaml` に `order: [bitflyer, binance, bybit, okx]` を保存。
- 既定は `config/ui/health.yaml`。

**実装**

- `ui_health.py`：D&D UI（Streamlit Sortable/自前実装）。ドロップ後に `svc_settings.save_ui('health', {...})` を呼ぶ。
- `svc_health.py`：`get_order()` で順序配列を取得、グラフ生成時にこの順で**系列を並べる**。

---

### 24.10 閾値・敷居の変更容易性（緑黄赤の基準）

**要件**

- 0 の仕様（`OK/WARN/CRIT`）は初期値として保持しつつ、**UI から即変更**できる。

**保存先とキー**

- `config/ui/health.yaml`

```yaml
thresholds:
  age_sec:
    ok: 15
    warn: 30
  latency_ms:
    warn: 500
    crit: 1500
  gap_rate:
    warn: 0.1
    crit: 0.3
window_min: 5 # スパークライン算出窓
```

- 既定は `config/ui/health.yaml` に同スキーマで保持。UI で「既定へ戻す」が可能。

**実装**

- `svc_health.py` が thresholds を読込み、`status` 判定ロジックに適用。
- UI はスライダ／数値入力で編集 → 保存時に検証（下限/上限）。

---


