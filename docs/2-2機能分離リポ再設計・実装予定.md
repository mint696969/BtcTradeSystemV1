# 2-2 機能分離リポ再設計・実装予定.md

## 14. 機能の実装順（スケジュール骨子 / マイルストン）

**Phase 0: 固定化と安全網**

- REPO_MAP/再設計キャンバス確定、`refactor/feature-modularization` ブランチ作成
- 入口多重起動防止の**暫定ロック**導入（監査出力まで）

**Phase 1: 設定まわりの足場**

- `config/exchanges/{defaults.yaml, registry.yaml}` と `<SECRETS_ROOT>` の導入
- UI「設定 → 取引所」タブの**一覧/順序/有効化**のみ先行（保存・復元）

**Phase 2: レート制御の中核**

- RateLimiter Registry（`global→group→endpoint`）の実体化、Collector で利用開始
- 429/Retry-After 対応・監査への一元出力

**Phase 3: UI の鍵管理＆自動取得**

- API 鍵の追加/削除/疎通テスト（鍵は `<SECRETS_ROOT>`）
- 可能な範囲のレート自動取得と overrides 反映

**Phase 4: ダッシュボードの分離徹底**

- providers を**純読取**に整理（副作用排除）
- Health/Audit ビューを新契約に合わせる

**Phase 5: 自動売買/戦略の切り出し**

- `features/autobot/` を Collector から分離し、RL 利用・監査統合

**Phase 6: 仕上げ**

- 命名の統一・不要物の凍結（`_legacy/` へ移送）
- REPO_MAP とドキュメント反映・ops スクリプトの最終統一

> 各 Phase は**後方互換優先**で、小さな PR に分解（壊れにくい変更から）

---

## 15. 整理ルール（ぐちゃぐちゃ防止・削除しない範囲で）

- “必要情報を消さない”を前提に、**重複・冗長・位置ズレ**を再配置（項目の集約・章立てのみ）
- 旧情報は末尾の「付録／Legacy」に移し、**参照箇所からリンク**
- 変更は**このキャンバス末尾に履歴を追記**し、要約を先頭近くへ反映

---

## 16. 迷子防止ルール（短名・浅い階層・ヘッダ様式 / 2025-10-12）

**目的**: キャンバスや VSC での探索を速くし、チャットが変わっても即再開できるようにする。

### 16.1 命名と階層（短く・浅く）

- **フォルダ名**: 英小文字・短名（推奨 ≤ 12 文字）。例: `collector`, `dash`, `health`, `audit`, `orders`, `bot`, `models`, `train`。
- **ファイル名**: 役割を 1 語追加（推奨 ≤ 20 文字）。例: `rate.py`, `worker.py`, `view.py`, `svc.py`, `cli.py`。
- **階層**: `features/<機能>/{core|app}` までを基本とし、その下は **最大+1 階層**（計 3〜4 段まで）。
- **プレフィクス**（混同回避）: `ui_`(画面) / `svc_`(サービス) / `cli_`(ツール) / `api_`(外部 I/F) / `mdl_`(モデル) など。必要最小限。
- **例（最終形の一部）**

  ```
  features/
    collector/{core/app}/ rate.py, worker.py, api_bybit.py
    dash/{core/app}/ ui_main.py, ui_health.py, providers.py
    health/{core/app}/ svc_status.py, ui_health.py
  ```

### 16.2 ファイル先頭の固定ヘッダ（2 行ルール）

- **1 行目**: `# path: features/<機能>/<core|app>/<ファイル名>.py`
- **2 行目**: `# desc: 役割を一言で（何をするファイルか）`
- **3 行目以降**（任意）: `# note: 依存/I/F/例外/保存先 などの箇条書き（短く）`
- **サンプル**

  ```python
  # path: features/dash/app/ui_health.py
  # desc: Healthタブの画面描画。providersから読み取りのみ、書き込み副作用なし。
  # note: input=data/collector/status.json, output=(none), audit=dashboard.view
  ```

### 16.3 キャンバスの命名（短縮表記）

- **形式**: `<機能>-<層>-<短名>`（例: `dash-app-ui_health`, `collector-core-rate`, `health-core-status`）
- **原則**: 20 文字前後で後半が欠けても識別できる短縮語を採用（`dash`, `collector`, `health`, `audit`, `orders`, `bot`, `models`, `train`）。

### 16.4 VSC での探索補助（運用 Tips）

- `# path:` をクイック検索すれば **一意に該当ファイルへ** 到達可能（「行頭一致」検索を推奨）。
- 拡張: 「ファイルヘッダスニペット」を用意して自動挿入（VSC ユーザースニペット）。

### 16.5 運用上の約束

- 新規ファイルは **必ず 2 行ヘッダ** を付ける。
- 階層を増やす必要が出たら、まず命名を短縮し **階層を増やさない** 方向で調整。
- 既存ファイルの大改修時は、`# desc:` を最新に更新（キャンバス側も同名で管理）。

---

## 17. 命名規約（最終 / 2025-10-12）

**目的**: 迷子防止・検索性・分離遵守。短名・浅階層・役割明示を徹底。

### 17.1 ディレクトリ / ファイル

- ルート構成: `common/`, `features/<feat>/{core|app}`, `config/`, `ops/`, `scripts/`, `tools/`。
- 機能名（<feat>）は短名: `collector`, `dash`, `health`, `audit`, `orders`, `bot`, `models`, `train`。
- **ファイル名は役割 1 語を付す**（推奨 ≤20 文字）: `rate.py`, `worker.py`, `svc.py`, `api_bybit.py`, `ui_main.py`, `ui_health.py`。
- **先頭 2 行ヘッダ必須**:

  ```
  # path: features/<feat>/<core|app>/<file>.py
  # desc: 一言で役割（入力/出力/副作用の有無が分かると尚良）
  ```

### 17.2 役割接頭辞 / 接尾辞（混同回避）

- `ui_*.py`（画面/Streamlit） / `svc_*.py`（サービス） / `cli_*.py`（ツール） / `api_*.py`（外部 I/F） / `mdl_*.py`（モデル）
- 取引所別は接尾辞で短縮: `api_bf.py`(bitFlyer), `api_okx.py`, `api_bb.py`(Bybit), `api_bi.py`(Binance)
- ワーカーは `*_worker.py`、レート制御は `rate.py`、状態集計は `status.py` を第一候補とする。

### 17.3 コード記号（Python）

- **クラス**: `PascalCase`（例: `RateLimiter`）
- **関数/変数**: `snake_case`（例: `get_tokens`）
- **定数**: `UPPER_SNAKE`（例: `POLL_SEC`）
- **例外名**: `PascalCaseError`（例: `RateLimitExceededError`）

### 17.4 I/F 依存方向

- **app → core → common** の一方向のみ。逆依存禁止。
- UI(app) は **読み取り専用**（副作用は監査出力のみを許可）。

### 17.5 追加の命名（横断）

- **ENV**: `BTC_TS_*`（機能別は `BTC_TS_<FEAT>_*`）
- **設定キー（YAML）**: `kebab-case` or `snake_case` のいずれかに統一（本プロジェクトは `snake_case` 推奨）
- **監査イベント名**: `feature.action`（例: `collector.pull`, `dash.view`, `bot.order.send`）
- **ログファイル**: `logs/{feat}/{feat}_YYYYMMDD.out/err.log`
- **PowerShell**: 短名＋動詞先頭（例: `start_dash.ps1`, `stop_coll.ps1`, `diag_api.ps1`）
- **ブランチ名**: `feat/<area>-<short>`, `fix/<area>-<short>`, `refactor/<area>-<short>`

### 17.6 サイズ規約（500 行上限 / 分割基準）

- **1 ファイルは原則 500 行以下**。超えそうなら**役割で分割**。
- **分割の指針**:

  - UI: 画面ごとに `ui_main.py` / `ui_health.py` / `ui_signals.py`
  - サービス: 読み取り `svc_read.py`、集計 `svc_agg.py`、検証 `svc_validate.py`
  - API クライアント: 取引所別 `api_bf.py` / `api_okx.py` / `api_bb.py` / `api_bi.py`
  - ワーカー: ストリーム/REST 別に `*_worker.py` を分割

- **循環参照を避ける**ため、共通処理は `common/` か 同階層の `util.py` へ抽出。

### 17.7 テスト / ツール

- テスト名: `tests/<feat>/test_<file>.py`（短名で対応）
- 形式的チェック: `tools/check_file_size.ps1` で 500 行超の検知（任意運用）。

> 以上を以後のファイル新設・改修の規範とする。違反が必要な場合は再設計キャンバスに例外理由を記録。

---

## 18. 設定と秘密情報の格納方針（確定 / 2025-10-12）

**目的**: “再構築なし”で長期運用。既定（defaults）と最終（registry/ui）を分離し、秘密は常にパッケージ外。UI で増減・並び替え・復元が完結。

### 18.1 ツリー／置き場

```
config/
  app.yaml                   # 共通アプリ設定（軽量・モード関連など）
  exchanges/
    defaults.yaml            # 出荷既定（取引所テンプレ）
    registry.yaml            # 運用中の現在値（有効/順序/上書き）
  ui_defaults/
    *.yaml                   # 画面の既定配置/トグル/列
  ui/
    *.yaml                   # 画面の最終状態（ユーザー保存）

<SECRETS_ROOT>/              # ※ENV: BTC_TS_SECRETS_DIR または run.ps1 で決定
  exchanges.secrets.yaml     # 各取引所の API 鍵/パスフレーズ 等（パッケージ外）
```

### 18.2 参照優先順位（マージ順）

1. **UI 最終**：`config/ui/*.yaml`（ユーザー操作の保存）
2. **Registry**：`config/exchanges/registry.yaml`（有効/順序/overrides）
3. **Defaults**：`config/exchanges/defaults.yaml`（出荷既定）
4. **Secrets**：`<SECRETS_ROOT>/exchanges.secrets.yaml`（鍵は常に別読込・未混在）

> ルール：**上位が下位を上書き**。Secrets は **設定に混ぜない**（参照のみ）。

### 18.3 ENV キー（標準）

- `BTC_TS_MODE`（PROD/DEBUG/DIAG）
- `BTC_TS_DATA_DIR`, `BTC_TS_LOGS_DIR`, `BTC_TS_MODELS_DIR`, `BTC_TS_ARTIFACTS_DIR`
- `BTC_TS_SECRETS_DIR`（Secrets 置き場ルート）
- `BTC_TS_NET_PREF` = `ipv4` / `ipv6` / `auto`（通信優先）

### 18.4 exchanges/defaults.yaml（縮約スキーマ）

```yaml
exchanges:
  - key: bitflyer
    label: bitFlyer
    enabled: false
    types: [spot]
    rate:
      rest:
        global: { capacity: 10, refill_per_sec: 5, burst: 5 }
        groups:
          market: { capacity: 10, refill_per_sec: 5 }
          orders: { capacity: 5, refill_per_sec: 2 }
      ws:
        send: { min_interval_ms: 200 }
    endpoints:
      rest_base: "https://api.bitflyer.com"
      ws_base: "wss://ws.lightstream.bitflyer.com"
    notes: "初期既定。テストで上書き可。"
```

### 18.5 exchanges/registry.yaml（運用中の現在値）

```yaml
order: [bitflyer, binance, bybit, okx]
enabled:
  bitflyer: true
  binance: true
  bybit: true
  okx: true
overrides:
  binance:
    rate:
      rest:
        global: { capacity: 1200, refill_per_min: 1200 }
```

### 18.6 secrets（パッケージ外 / 必ず別保管）

```yaml
bitflyer: { api_key: "***", api_secret: "***" }
okx: { api_key: "***", api_secret: "***", passphrase: "***" }
```

- 位置は `BTC_TS_SECRETS_DIR` で指定。Git 管理外。
- UI からの保存先もここ固定（キャンバス/設定ファイルには埋め込まない）。

### 18.7 バリデーション / 監査

- **スキーマ**: `common/contracts/config_schemas.py`（pydantic など）で validate。
- **監査**: 設定変更は `audit.jsonl` に `event=config.update, actor, site, session, file, keys` を記録。
- **スナップショット**: 主要設定を `config/snapshots/yyyymmdd-HHmm.yaml` に自動保存（復元に使用）。

### 18.8 UI 要件（設定 → 取引所）

- 一覧（有効/順序の D&D）／詳細（rate・endpoints・notes）／**鍵入力は別保管**
- **テスト**時に取得できたヘッダ（`Retry-After` 等）を **registry.overrides** に反映
- **復元**: UI 既定へ／exchanges 既定へ—を別ボタンで提供

### 18.9 通信ポリシー（IPv4/IPv6）

- 既定は `BTC_TS_NET_PREF=ipv4`（Binance/Bybit に AAAA 無のため）
- HTTP 層は `ipv4/ipv6/auto` を選択可能。**curl 依存はしない**（.NET/Python 標準 TLS）。

### 18.10 運用ツール（任意）

- `tools/backup_config.ps1`：`config/` と `secrets/` の暗号化バックアップ
- `tools/diff_config.ps1`：defaults vs registry/ui の差分表示
- `scripts/diag/api_connectivity.ps1`：API 疎通（IPv4 優先）

> これらを基準とし、以後の追加機能も同じ規約で拡張する。

---
