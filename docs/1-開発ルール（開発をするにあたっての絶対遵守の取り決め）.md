# 開発ルール（開発をするにあたっての絶対遵守の取り決め）

## 目的と適用範囲

- 本書は、BtcTradeSystem の開発・保守を効率化し、チャット移行時の認識齟齬・時間ロスを最小化するための不変規約を定義する。
- 頻繁に改定しない規約・基本ルールを集約し、リポジトリ内とプロジェクトファイル内に配置する。
- ライブ情報は常設キャンバスにのみ記録、重複は避ける。

## チャット／キャンバス運用

常設キャンバス（BtcTS-ライブ引継ぎ・REPO_MAP）

- 流動的な情報（ディレクトリ設計図、課題、進捗、ToDo）は常設キャンバスに集約する。
- 新チャット開始時はこの 2 種類のキャンバスを開き、以降の前提はこれに従う。
- BtcTS-ライブ引継ぎ・REPO_MAP キャンバスはユーザーの指示がない限り改変禁止とします。

その他キャンバス運用

- 1 ファイル = 1 キャンバスとしユーザーのファイルと GPT が見るコードをキャンバスを介し同期させ、キャンバスの使いまわしはしない。
- キャンバス名は格納フォルダ/ファイル名（拡張子も記載）とし長いフォルダ名は避ける。
- コード確認用のキャンバスは既に存在する場合はそれを使用し、存在しない場合は py 用の空のキャンバスを作成する事。
- 同名または同一ファイル用のキャンバスが複数存在する場合は最新の物のみ使用し他は空にして使用しない事。
- キャンバスを開く際はチャット欄が間延びしないよう最小限の折り畳み表示にする事。
- キャンバスを作成する場合はチャット欄へ展開せずチャット欄が間延びしないよう必要最小限にすること。

## コマンド実行と新規ファイル作成

- コマンド実行指示を出す場合は PowerShell7 用のコマンドにすること。
  コピペでエラーが出るような+や-や PS>などの符号は付けない事。
- ミスを防ぐためコマンド実行は PowerShell、ファイル作成は Python など、用途をコピーされないよう提案コードの左上に差し込むこと。
- 必ず設置場所と拡張子も含めたファイル名を伝えること。
  新規ファイルを作成する場合は、先頭にコメントで設置場所/対象ファイル名、2 行目に簡単な説明を入れる。
  例：
  1 行目：# path: tools/make_repo_map_extract.py
  2 行目：# desc: リポジトリを走査し、各ファイル先頭の「# path / # desc」を抽出して REPO_MAP の Markdown / YAML を生成（make_handoff.ps1 からのサブプロセス呼び出し対応）

## コード修正・差し替え方針

- 必ずキャンバスの最新コードを参照した上で修正提案すること。
- 曖昧な推測や憶測での修正提案は禁止。必ず現物コードかアップロード済みファイルを元にすること。
- 差し替えは「検索目安コード」を明記し、その直後に追加／置換する形で指示すること。
- コードは「注釈付きブロック」単位で提示し、コピペ差し替え可能にする。（1 行差し替えや少数行の場合はその限りではない）
- 大規模・複雑な変更はキャンバスにファイル全文を提示して差し替える。
- 行数が多い場合はチャットで挿入位置を明示する。
- 冗長な背景説明は不要。実際の修正箇所を明確に示すこと。
- 提案時は「どこを検索 → どこを差し替え → 完成形イメージ」の順で指示する。

------------------------指示-例
コード追加：
設置場所/対象ファイル名
検索できる現物のコード（指示例：このコードの上または下へ追加）
指標となる現物コード行
挿入コード（インデントを考慮したコピペできる形）

コードの差替え：
設置場所/対象ファイル名
検索できる現物のコード（指示例：始まりコード～終わりコードを差替え）
指標となる現物コード範囲（範囲全文）
差し替えコード

コード削除：
設置場所/対象ファイル名
現物に存在するコードのここからここまで削除
検索できる現物のコード（指示例：始まりコード～終わりコードを削除）
指標となる現物コード範囲（範囲全文）

---

コード修正のやり取り方針:

- コードは必ず現物をキャンバスに貼り付け、GPT は精査の上修正を反映する。
- 設置場所が分かるように対象ファイル名を明示し修正を行う。
- 常に現物コードベースで正確に修正し、チャットを無駄に長くしない。

## ブロック差し替えルール

- 変更は「見出しコメント＋最小ブロック」で提示する（例：# Paths / # Collector start (background) など）。
- ブロックは重複しない見出しを先頭に置き、その見出しから次の見出しの直前までを置換対象とする。
- 見出しには余計な装飾（[BLOCK ...] 等）は使わず、何をするブロックかわかる簡潔な見出しにすること。
- ブロック末を示すコメントは付けない。
- 全文差し替えが必要な場合はファイル全文をキャンバスに提示する。
- すべての差し替えはコピペ一発で再現可能にする。

## 構成規約

- UI ハブ: apps/dashboard.py は薄く保ち、配線のみ担当。
- 機能分割: boards/dashboard/{snapshot, plot, assist, freshness, providers, settings_panel, tabs/\*}。
- データ I/F: providers.py に集約（resolve_data_dir / get_freshness / get_forecast）。
- 設定: lib/settings.py 経由で config/ui_defaults/\*.yaml を既定、右上 ⚙ は settings_panel.render_settings_compact()。
- i18n: config/i18n_ja.json を最優先（apps/i18n_ja.json は将来削除）。
- データ/ログ: 環境変数 BTC_TS_DATA_DIR / BTC_TS_LOGS_DIR または ./data, ./logs（git 管理外）。

## コーディング規約

- Python 3.10+ / 型ヒント必須。
- 1 モジュール 700 行未満。Streamlit は width を使用（use_container_width 非推奨）。
- ロギングは print 乱用を避け、将来 logging へ差替え可能な薄いラッパを使う。
- 例外は握り潰さず UI は『落とさない』を最優先。
- 依存は requirements.txt に明示。

## データ・I/F 契約

- providers.resolve_data_dir(data_dir: Optional[Path]) -> Path
- providers.get_freshness(data_dir: Optional[Path]) -> List[Dict] // status.json 優先、raw/latest フォールバック
- providers.get_forecast(data_dir: Optional[Path], symbol: str, \*\*kwargs) -> Dict // forecast/latest.json → forecast_provider → mock
- settings.load(feature) / save(feature, data) / reset_to_defaults(feature)
- i18n.t(key) / i18n.get_series_map() // config/i18n_ja.json を優先

## 変更要求テンプレート

- 対象ファイル: <path>
- 置換/追加: <replace|insert> / <直前の行や def 名>
- ブロック: `python ... `
- 動作確認方法: <PowerShell/pytest/Streamlit など>

## テスト／運用コマンド例

- 起動: .\scripts\start_dashboard.ps1 -DashConsole -ShowStatus
- ログ追尾: Get-ChildItem .\logs\collector*\*.out.log | Sort LastWriteTime | Select -Last 1 | % { $*.FullName; Get-Content $\_ -Tail 80 }

## 起動統一ルール

- collector の起動口は btc_trade_system/ops/collector/start_collector.ps1 のみ。
- 呼び出し側（scripts/run.ps1 等）はこの 1 本を参照し、委譲スクリプトは作らない。

## 品質基準

- 返すコードは本番利用可が前提。サンプル・仮コードは禁止。
- 曖昧な場合も安全側で実装し、出来たところまで即時提示。
- すべての差し替えは再現可能性（コピペ置換）を担保。

## テスト・確認

- 修正後は PowerShell での実行例や確認コマンドを必ず示すこと。
- collector, dashboard など重要プロセスは「別シェルでの確認方法」まで含めて案内する。

## 引き継ぎ資料

- 日ごとの追加変更は「ライブ引継ぎ」キャンバスに番号を振って追記。
- 書式は見出し（番号＋日付）＋箇条書きで統一。

## 再開（新チャット）手順

1. プロジェクトファイル内をしっかり熟読し理解すること
2. GPT が **プロジェクトファイル＋キャンバス**（ライブ引継ぎ/Repo Map）をロードまたは新規作成すること。
3. 現物の差分があれば：最新ツリーを貼付 → Repo Map を更新 → 要点のみ `docs/` に反映
4. 次タスクへ着手（`docs/2-*` の優先リストに従う）

## 運転モードの効率的な使い方（方針のみ）

- **PROD**：通常運用。監査は最小。問題なければ常時これ。
- **DEBUG**：UI/ロジックの挙動確認・再現記録。
- **DIAG**：原因特定に短時間だけ切替（`logs/audit.jsonl` を採取）→ 終われば**必ず PROD に戻す**。
- 切替は **Dashboard の設定パネル**（`config/settings.yaml` の `runtime.mode` に永続化）。
- 具体手順・調べ方は **別紙（運転モードと監査）** を参照。

