# 開発監査システム 最終仕様書（vFinal）

---

## 概要

本仕様書は、BtcTradeSystem V1 における **開発監査（Dev-Audit）機構** の正式仕様を示すものであり、
開発・運用・検証・自動化・学習各フェーズでの利用を目的とする。

監査システムは以下 2 本の成果物を中心に設計されている：

- **監査ログ（logs/dev_audit.jsonl）** … 実行中の全イベント・例外・I/O・API・発注等を構造化記録
- **スナップショット（logs/boost_snapshot.json / handover_gpt.txt）** … 現在の構成・状態・直近イベントの要約

これらを合わせて「開発監査システム」と呼ぶ。

---

## 構成要素と役割

### 1. writer.py

- 監査の**出力側**。どのイベントを記録するかをモードごとに制御。
- ファイル: `./btc_trade_system/features/audit_dev/writer.py`

| モード | 出力レベル閾値                             | 代表的な用途                |
| :----- | :----------------------------------------- | :-------------------------- |
| OFF    | ERROR↑ のみ or 完全停止                    | 運用中最小記録 / 再現不要時 |
| DEBUG  | WARN↑                                      | 開発中の不具合調査          |
| BOOST  | 全レベル記録（DEBUG,INFO,WARN,ERROR,CRIT） | 詳細な検証・学習データ作成  |

**既知キーの通過（KNOWN_PASS）**：
`trace_id, decision_id, symbol, venue, order_id, client_order_id, side, qty, price, latency_ms, retry, backoff_ms, quota_bucket, remaining, policy, score`
→ これらは payload 内で必ず保存され、後続分析の相関キーとなる。

**ローテーション**：
128MB 超時に末尾 32MB を原子的に保持。

**マスク / 縮約ポリシー**：
PII や長文文字列を自動短縮、セキュリティに配慮。

---

### 2. log_ui.py / summary_panels.py

- **UI 側の可視化層**。Streamlit 上で最新の監査状態を簡易に確認可能。

#### サブパネル構成

| パネル           | 内容                                    | 情報源           |
| :--------------- | :-------------------------------------- | :--------------- |
| Collector Health | 直近の heartbeat / fetch / dropped 件数 | dev.collector.\* |
| API Quota        | API 呼出回数・429 件数・残量            | dev.api.\*       |
| Orders Timeline  | 直近 50 件の注文イベント                | dev.order.\*     |

> これらは `audit_dev/summary_panels.py` に分離されており、UI 肥大を防止。

**レベル/時刻正規化**：

- `level` のゆれ（warning/err/int 数値）を正規化。
- `ts` は ISO8601Z / epoch / epoch_ms いずれにも対応。

---

### 3. boost.py（スナップショット生成）

- **handover 用スナップショット**の公式エントリーポイント。
- 関数：`export_and_build_text(mode: str, force: bool)`

#### 処理フロー

1. `_export_snapshot()` により最新 JSON を生成。
2. `_build_handover_text()` により初期 Markdown を構築。
3. `mode` に応じて追記を制御。

| モード       | 追記内容                                            |
| :----------- | :-------------------------------------------------- |
| DEBUG        | `errors_summary`, `errors-only tail (last 20)`      |
| BOOST        | 全情報（LITE/FULL）＋要約部                         |
| 両モード共通 | `## Decisions (last 50)` （学習・解析向け決定抜粋） |

4. 完成した Markdown を `logs/handover_gpt.txt` に保存。

---

### 4. snapshot_compose.py

- スナップショット本文組立。以下の主要ブロックを生成：

| 関数                              | 出力                                   | 用途                       |
| :-------------------------------- | :------------------------------------- | :------------------------- |
| `ensure_errors_summary_in_text()` | errors_summary を Markdown 節に挿入    | 直近の ERROR/CRIT 件数把握 |
| `build_tail_block()`              | audit_tail (last N) / errors-only tail | 末尾イベント表示           |
| `build_decisions_block()`         | Decisions (last N)                     | 学習/意思決定ログ抜粋      |

---

### 5. logs/dev_audit.jsonl

- 行単位 JSON 構造。

主要フィールド例：

```json
{
  "ts": "2025-10-24T03:12:55.124Z",
  "level": "ERROR",
  "feature": "collector",
  "event": "dev.collector.heartbeat",
  "trace_id": "ABC123",
  "payload": {
    "lag_ms": 120,
    "fetched": 450,
    "dropped": 3
  }
}
```

- UI やスナップショットが参照する一次データ。
- 外部からの直接編集は禁止。

---

## 各モードで得られる情報と開発活用例

| モード    | 得られる主情報                                                         | 主な活用                         |
| :-------- | :--------------------------------------------------------------------- | :------------------------------- |
| **OFF**   | 重大例外のみ / 設定最小                                                | 運用時の軽量監査、障害検知       |
| **DEBUG** | 警告以上＋ errors_summary ＋ errors-only tail ＋ Decisions             | バグ調査・軽量リプロ構築         |
| **BOOST** | 全イベント＋ Decisions ＋ REPO_MAP ＋ audit_tail150 ＋ Env ＋ Versions | 詳細解析、モデル再学習、再現試験 |

---

## 使い方 / 開発手順

### スナップショット生成

```powershell
# 強制生成 (BOOST)
python - <<'PY'
from btc_trade_system.features.audit_dev.boost import export_and_build_text
p,t = export_and_build_text(mode="BOOST", force=True)
print(p)
PY
```

→ `logs/boost_snapshot.json`, `logs/handover_gpt.txt` が更新される。

### LOG テスト

```powershell
python .\tmp\test_writer_emit_matrix.py
```

→ 各モードで記録されるレベルの違いを確認。

### スナップショットテスト

```powershell
python .\tmp\test_decisions_section.py
python .\tmp\test_decisions_boost.py
```

→ handover_gpt.txt 内の Decisions 節の有無を確認。

---

## スナップショットの見方

```
# BtcTradeSystemV1 Handover (DEBUG)
## Roots
... システムパス・Git情報 ...
## Env (sanitized)
... 環境情報 ...
## REPO_MAP
... 構成ファイルマップ ...
## audit_tail (errors-only, last 20)
... 最新20件のエラー要約 ...
## Decisions (last 50)
... dev.decision.*, dev.signal.*, dev.strategy.* 抜粋 ...
```

---

## 新機能組込み時の指針

### コード作成時のヘッダコメント規約

```python
# path: ./module/submodule/filename.py
# desc: ファイル概要（目的・主な機能）
```

→ `make_repo_map_extract.py` による自動ドキュメント生成対応。

### 新しい機能の監査統合

```python
from btc_trade_system.features.audit_dev import writer as W
W.emit("dev.order.place", level="INFO", feature="orders", payload={
    "trace_id": trace_id,
    "symbol": "BTC/JPY",
    "price": 7000000,
    "qty": 0.01,
})
```

→ LOG/スナップショットの両方で観測可能。

### レート制御・健全性監査

```python
W.emit("dev.api.quota", level="INFO", feature="api", payload={
    "remaining": remaining,
    "bucket": bucket_id
})
```

→ summary_panels の Quota パネルで自動反映。

---

## 学習/再現活用の指針

- `## Decisions` 節：モデル再訓練用データの抽出に利用可。
- `logs/dev_audit.jsonl`：教師データ整備（イベント発生履歴）に利用。
- `boost_snapshot.json`：環境・バージョン・設定の完全再現を保証。

---

## 付録：BOOST/DEBUG 差異表

| 項目                      | DEBUG       | BOOST             |
| :------------------------ | :---------- | :---------------- |
| 記録閾値                  | WARN↑       | ALL               |
| errors_summary            | ✅          | ✅                |
| errors-only tail          | ✅ (20 件)  | ❌ (全件 tail150) |
| REPO_MAP / Env / Versions | ✅ (簡易)   | ✅ (完全)         |
| Decisions                 | ✅ (last50) | ✅ (last50)       |
| スナップショット頻度制限  | 10 秒       | 10 秒             |
| handover 出力             | Markdown    | Markdown          |

---

## 今後の拡張案

- API レート制御トグル（BOOST 時ノイズ低減）
- 異常検知の赤黄緑バッジ表示
- スナップショット schema_rev 出力（差分追跡）
- 自動化学習パイプラインとの連携（決定ログ → 教師データ）

---

以上。
