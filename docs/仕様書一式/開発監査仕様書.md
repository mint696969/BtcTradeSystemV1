# 開発監査スナップショット仕様書

## 1. 概要

本仕様書は、BtcTradeSystemV1 における **開発監査（Dev Audit）スナップショット機能**の構造、役割、使用方法を定義する。スナップショット機能は、開発時のシステム状態・環境情報・監査ログ・リポジトリ構成を即座に保存し、問題解析や GPT 引継ぎ用のハンドオーバーテキストとして活用できる仕組みである。

---

## 2. スナップショット機能の目的

- 開発・検証中の状態を**瞬時に再現可能な形**で保存。
- 障害や異常時の**即時デバッグ支援**。
- **開発監査（Dev Audit）**との統合により、行動履歴や内部イベントを同一タイムライン上で追跡可能。
- GPT・人間問わず、第三者に状態を**正確に引き渡す**ための Handover テキスト出力。

---

## 3. 主構成ファイル

| ファイル                                 | 役割                                                                                  |
| ---------------------------------------- | ------------------------------------------------------------------------------------- |
| `common/boost_svc.py`                    | スナップショットの生成および handover テキスト出力ロジックの中核。                    |
| `features/audit_dev/snapshot_ui.py`      | Streamlit 上でのスナップショット表示ウインドウ描画および CSS 管理。                   |
| `features/audit_dev/snapshot_compose.py` | スナップショットテキスト構築の補助。メタ情報、errors_summary、REPO_MAP 生成を担当。   |
| `features/audit_dev/writer.py`           | 監査ログの公式書込みインターフェース（audit_event / audit_info / audit_error など）。 |
| `features/dash/audit_ui.py`              | UI トリガー部。トグル操作や Snapshot ボタンの呼び出し管理。                           |

---

## 4. スナップショット構造（boost_snapshot.json）

スナップショットは `logs/boost_snapshot.json` に JSON 形式で保存され、以下の主な構成を持つ：

| キー              | 説明                                                                     |
| ----------------- | ------------------------------------------------------------------------ |
| `ts`              | UTC 時刻（ISO8601）                                                      |
| `mode`            | DEBUG / BOOST                                                            |
| `roots`           | data/logs/repo 各ルートパス                                              |
| `env`             | 環境変数情報（BTC_TS_MODE など）                                         |
| `versions`        | Python / OS / Streamlit などの環境バージョン情報                         |
| `files`           | 主要ログファイル（audit.jsonl / dev_audit.jsonl / handover_gpt.txt）情報 |
| `settings_digest` | `config/settings.yaml` の存在とハッシュダイジェスト                      |
| `recent`          | 監査ログの末尾（tail）および ERROR/CRIT 抽出結果                         |
| `repo_map`        | リポジトリ構造の抜粋 (#path/#desc)                                       |
| `processes_top`   | 実行中プロセス上位（BOOST のみ）                                         |
| `tree`            | data/logs ディレクトリの薄いツリー情報（BOOST のみ）                     |

---

## 5. 出力ファイル

| 出力ファイル               | 内容                                               |
| -------------------------- | -------------------------------------------------- |
| `logs/boost_snapshot.json` | スナップショットデータ（構造・環境・監査ログなど） |
| `logs/handover_gpt.txt`    | GPT / 引継ぎ用のテキスト整形済みスナップショット   |

### Handover テキスト構造（簡略）

```
# BtcTradeSystemV1 Handover (BOOST)
- ts: 2025-10-22T13:04:59Z
## Roots
## Env
### Versions
### Files (logs)
### config/settings.yaml (digest)
## Loaded modules (BOOSTのみ)
## REPO_MAP (excerpt)
## Errors & Critical (recent)
## Recent dev_audit tail
## Processes (BOOSTのみ)
## How to reproduce (PowerShell)
```

---

## 6. UI 動作仕様

### モードトグル

- OFF / DEBUG / BOOST の 3 段階。
- モードはセッション内のみ保持（再起動時リセット）。
- BOOST 選択時はスナップショット生成（`export_snapshot(force=True)`）を自動実行。

### スナップショット表示ウインドウ

- Streamlit で常時 10 行固定・縦横スクロール可能なコード枠を表示。
- 空時でもボックスを維持（UI 崩壊防止）。
- 内容は `render_snapshot_code(text)` により描画。

---

## 7. 付随機能

- `errors_summary`: dev_audit.jsonl の末尾 150 行から ERROR/CRIT 件数と範囲を算出。
- `repo_map_excerpt`: REPO_MAP.extract.md 抜粋。重複排除済み。
- `writer` モジュール経由で統一フォーマットで監査ログを追加。
- DEBUG: 軽量出力（モジュールリスト/プロセス省略） BOOST: フル情報出力。

---

## 8. 使用方法

1. **ダッシュボードの Audit タブを開く。**
2. **モードトグルを切替（DEBUG または BOOST）。**
3. **「Snapshot」ボタンをクリック。**

   - `boost_svc.export_snapshot()` が呼び出され、スナップショット JSON が生成。
   - 直後に `handover_gpt.txt` が出力。

4. **UI 下部に出力されるテキスト枠**から内容をコピーして GPT へ転送可。

---

## 9. エラー処理と安全設計

- 書込みはすべて `io_safe.write_atomic()` により原子的上書き。
- スナップショット生成は 10 秒以内の再実行を抑制（RATE 制御）。
- 書込み失敗時は `.tmp` へ退避し再試行。

---

## 10. 拡張予定

- 差分比較ビュー（複数スナップショット間の比較）。
- メタバー拡張（branch / commit の追加）。
- REPO_MAP の自動更新と REPO 構造監査との統合。

---

## 付録：関連テストスクリプト

| ファイル                    | 内容                                          |
| --------------------------- | --------------------------------------------- |
| `tmp/dev_audit_smoke.py`    | 監査ログ書込みテスト（INFO/ERROR を記録）。   |
| `tmp/dev_snapshot_smoke.py` | スナップショット生成・handover テキスト検証。 |

---

## 付録：BOOST／DEBUG モード差異一覧

| 項目                    | DEBUG                      | BOOST                                |
| ----------------------- | -------------------------- | ------------------------------------ |
| スナップショット出力    | LITE（軽量）               | FULL（詳細）                         |
| REPO_MAP 出力           | 最大 50 件                 | 最大 200 件（内部保持 300 件）       |
| data/logs ツリー情報    | 省略                       | 出力（最大深度 2, 最大 200 件）      |
| モジュールリスト        | 省略                       | 最大 1000 件（表示は 50 件）         |
| プロセス情報            | 省略                       | psutil により上位 20 プロセスを出力  |
| dev_audit_tail 行数     | 20                         | 100                                  |
| audit_tail 行数         | 20                         | 50                                   |
| dev_audit_err_tail 行数 | 20                         | 100                                  |
| audit_err_tail 行数     | 20                         | 50                                   |
| REPO_MAP 重複排除       | 共通実装（path 正規化）    |                                      |
| Handover テキスト出力   | 生成対象外（JSON のみ）    | JSON + handover_gpt.txt 同時出力     |
| UI 自動スナップショット | トグル切替時に実行されない | トグル切替時に強制実行（force=True） |
| 出力目的                | 開発中の軽量検証・動作確認 | リリース直前・詳細調査・GPT 引継ぎ用 |

---

# 開発監査ログ仕様書（Dev Audit Logging Spec）

## 概要

本モジュールは開発時限定の監査ログ機構であり、  
主に「Streamlit ダッシュボードの開発監査タブ」から動作・確認できる。  
アプリケーション動作に影響せず、**開発支援・不具合解析・GPT 共有**を目的とする。

### 主構成ファイル

| ファイル                       | 概要                                                                        |
| ------------------------------ | --------------------------------------------------------------------------- |
| `features/audit_dev/writer.py` | ログ出力本体（I/O 制御・マスキング・トリム・軽量レート制御）                |
| `features/audit_dev/log_ui.py` | ログビュー（JST 表示・24h・最大 50 行）                                     |
| `features/dash/audit_ui.py`    | Streamlit タブ UI。BOOST 切替でスナップショット生成・DL・追加オプション制御 |

---

## 1. ログファイル仕様

### 1.1 ファイル構成

- 出力先: `logs/dev_audit.jsonl`
- 形式: **1 行 1JSON（UTF-8 / 改行 LF）**
- 最大容量: 128 MB を超えると **末尾 32 MB を自動保持（原子的置換）**
- 書込排他: `portalocker` を利用（未導入時はスレッドロック）

### 1.2 モード種別

| モード  | 出力内容                        | 想定用途             |
| ------- | ------------------------------- | -------------------- |
| `OFF`   | 監査停止（エラー行も出さない）  | 通常運用時           |
| `DEBUG` | `WARN` 以上のみ記録             | 開発時軽負荷監視     |
| `BOOST` | 全レベル記録（`DEBUG`〜`CRIT`） | 詳細解析・GPT 報告用 |

モードは非永続であり、起動時は常に `OFF`。  
UI ボタン（OFF → DEBUG → BOOST → OFF）で循環する。

### 1.3 レベル階層

`DEBUG < INFO < WARN < ERROR < CRIT`  
出力フィルタは `_should_emit()` によって決定される。

---

## 2. レコード構造

### 2.1 フィールド

| フィールド                                     | 型       | 説明                                                   |
| ---------------------------------------------- | -------- | ------------------------------------------------------ |
| `ts`                                           | str      | UTC ISO8601 + ミリ秒（例: `2025-10-23T10:10:59.798Z`） |
| `mode`                                         | str      | 実効モード（OFF/DEBUG/BOOST）                          |
| `event`                                        | str      | `"dev."` 接頭辞付きイベント名                          |
| `feature`                                      | str      | 呼出元機能名（例: `"audit_dev"`）                      |
| `level`                                        | str      | ログレベル                                             |
| `actor`, `site`, `session`, `task`, `trace_id` | 任意     | 呼出メタデータ                                         |
| `payload`                                      | dict/str | ユーザデータ。マスク＋サイズ制限済み                   |

### 2.2 マスキングと縮約

- **キーワード一致マスク**  
  `key|secret|token|pass|cookie|authorization|credential|api_key` などを含むキーは値を `[REDACTED]` に置換。
- **サイズ制限**
  - 各フィールド最大 2 KB
  - 行全体最大 約 10 KB  
    超過時は `"...(truncated N bytes)"` を付記。

### 2.3 例

```json
{"ts":"2025-10-23T10:10:59.748Z","mode":"BOOST","event":"dev.ui.test.bulk","feature":"audit_dev","level":"DEBUG","payload":{"i":16,"note":"ui test bulk"}}

---

## 3. 機能詳細（writer.py）
### 3.1 set_mode / get_mode
set_mode("DEBUG") 等で切替。

切替操作は emit() を通さず _log_toggle_raw() により必ず1行記録。

### 3.2 emit()
ログを1行書き込む基本I/F。
内部的にマスク→縮約→JSON化→fsync までを一括処理。

呼出エイリアス
python
コードをコピーする
audit_debug(event, **kw)
audit_info(event, **kw)
audit_warn(event, **kw)
audit_error(event, **kw)
audit_crit(event, **kw)

---

## 4. 軽量レート制御（BOOST時のみ有効）
概要
BOOST中に DEBUG/INFO の連発がある場合、
短時間での重複出力を抑制し、要約を1行だけ出す。

定数	意味	既定値
_RATE_ENABLED	Trueで有効（既定False）	False
_RATE_WINDOW_MS	判定窓長	2000
_RATE_MAX_PER_WINDOW	1窓で許容する最大行数	60
_RATE_SUMMARY_EVERY	Drop件数がこの倍数の時に要約を出す	200

出力例
json
コードをコピーする
{"event":"dev.rate.dropped","level":"INFO","payload":{"sig":"dev.ui.test.bulk|DEBUG|audit_dev|dict|ui test bulk","dropped":200,"window_ms":2000}}
WARN/ERROR/CRIT は間引かれない。

---

## 5. ログビュー（log_ui.py）
表示仕様
項目	値
対象ファイル	logs/dev_audit.jsonl
表示期間	過去24時間
表示件数	最大50行（新しい順）
行高	固定10行（CSS制御）
時刻	JST変換表示
フィルタ	キーワード一致（event / feature / payload / level）
DL機能	JSONL（ts_jst付き）最大500行
Auto refresh	2 s間隔（ON/OFF切替可能）

---

## 6. UI構成（audit_ui.py）
### 6.1 モードトグル
OFF / DEBUG / BOOST を循環。

切替時に writer へ即反映。

BOOST へ入るとき auto_snap_on_boost がONならスナップショット自動生成。

### 6.2 スナップショット生成
種別	内容
LITE (DEBUG)	roots / env / log tail（20行）
FULL (BOOST)	上記＋env/version/files/audit_tail/config_digest/procs/DOM

出力はメモリ上 (st.session_state.snapshot_text)
DLボタンで handover_gpt.txt として保存。

### 6.3 付加オプション
キー	内容	既定
opt_repo_map	REPO_MAP抜粋を末尾へ追記	✅
opt_tail150	dev_audit.jsonl末尾150行を付加	☐
opt_env_versions	EnvとVersionsを追記	☐
opt_err_tail	Errors only tailを付加	✅
auto_snap_on_boost	BOOST突入時の自動スナップショット	☐

---

## 7. 運用ガイド
通常はOFF運用
問題解析・動作確認時のみ DEBUG または BOOST に切替。

BOOSTのログ量に注意
GPT提出用は _RATE_ENABLED=True 推奨。

スナップショット

BOOST時に手動ボタンまたは自動撮影で取得。

handover_gpt.txt にまとめて保存可。

ログのDL
log_ui.py 下部の「ログをダウンロード（JST・最大500行）」で取得。

ファイルサイズ管理
128 MB超過時は末尾32 MBのみ保持される。

---

## 8. 既知制限
マルチプロセス同時書き込みは portalocker 非導入環境では安全でない。

レート制御はプロセス単位（グローバル共有ではない）。

スナップショットはUIセッションに依存し、外部API経由での取得は未対応。

---

## 9. 今後の拡張候補
trace_id 自動付与（withコンテキスト）

例外キャプチャデコレータ @audit_exceptions

dev.rate.dropped 要約の可視化タブ

CI用 auditlint.py（壊れたJSON検知）


Last updated: 2025-10-23
**作成者:** 開発監査チーム（BtcTradeSystemV1）
```
