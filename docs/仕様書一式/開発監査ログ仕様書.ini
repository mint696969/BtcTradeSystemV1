# 開発監査ログ仕様書（Dev Audit Logging Spec）

## 概要
本モジュールは開発時限定の監査ログ機構であり、  
主に「Streamlit ダッシュボードの開発監査タブ」から動作・確認できる。  
アプリケーション動作に影響せず、**開発支援・不具合解析・GPT共有**を目的とする。

### 主構成ファイル
| ファイル | 概要 |
|-----------|------|
| `features/audit_dev/writer.py` | ログ出力本体（I/O制御・マスキング・トリム・軽量レート制御） |
| `features/audit_dev/log_ui.py` | ログビュー（JST表示・24h・最大50行） |
| `features/dash/audit_ui.py` | StreamlitタブUI。BOOST切替でスナップショット生成・DL・追加オプション制御 |

---

## 1. ログファイル仕様
### 1.1 ファイル構成
- 出力先: `logs/dev_audit.jsonl`
- 形式: **1行1JSON（UTF-8 / 改行LF）**
- 最大容量: 128 MB を超えると **末尾32 MBを自動保持（原子的置換）**
- 書込排他: `portalocker` を利用（未導入時はスレッドロック）

### 1.2 モード種別
| モード | 出力内容 | 想定用途 |
|--------|-----------|-----------|
| `OFF` | 監査停止（エラー行も出さない） | 通常運用時 |
| `DEBUG` | `WARN` 以上のみ記録 | 開発時軽負荷監視 |
| `BOOST` | 全レベル記録（`DEBUG`〜`CRIT`） | 詳細解析・GPT報告用 |

モードは非永続であり、起動時は常に `OFF`。  
UIボタン（OFF → DEBUG → BOOST → OFF）で循環する。

### 1.3 レベル階層
`DEBUG < INFO < WARN < ERROR < CRIT`  
出力フィルタは `_should_emit()` によって決定される。

---

## 2. レコード構造
### 2.1 フィールド
| フィールド | 型 | 説明 |
|-------------|----|------|
| `ts` | str | UTC ISO8601 + ミリ秒（例: `2025-10-23T10:10:59.798Z`） |
| `mode` | str | 実効モード（OFF/DEBUG/BOOST） |
| `event` | str | `"dev."` 接頭辞付きイベント名 |
| `feature` | str | 呼出元機能名（例: `"audit_dev"`） |
| `level` | str | ログレベル |
| `actor`, `site`, `session`, `task`, `trace_id` | 任意 | 呼出メタデータ |
| `payload` | dict/str | ユーザデータ。マスク＋サイズ制限済み |

### 2.2 マスキングと縮約
- **キーワード一致マスク**  
  `key|secret|token|pass|cookie|authorization|credential|api_key` などを含むキーは値を `[REDACTED]` に置換。  
- **サイズ制限**  
  - 各フィールド最大 2 KB  
  - 行全体最大 約10 KB  
  超過時は `"...(truncated N bytes)"` を付記。  

### 2.3 例
```json
{"ts":"2025-10-23T10:10:59.748Z","mode":"BOOST","event":"dev.ui.test.bulk","feature":"audit_dev","level":"DEBUG","payload":{"i":16,"note":"ui test bulk"}}

---

## 3. 機能詳細（writer.py）
### 3.1 set_mode / get_mode
set_mode("DEBUG") 等で切替。

切替操作は emit() を通さず _log_toggle_raw() により必ず1行記録。

### 3.2 emit()
ログを1行書き込む基本I/F。
内部的にマスク→縮約→JSON化→fsync までを一括処理。

呼出エイリアス
python
コードをコピーする
audit_debug(event, **kw)
audit_info(event, **kw)
audit_warn(event, **kw)
audit_error(event, **kw)
audit_crit(event, **kw)

---

## 4. 軽量レート制御（BOOST時のみ有効）
概要
BOOST中に DEBUG/INFO の連発がある場合、
短時間での重複出力を抑制し、要約を1行だけ出す。

定数	意味	既定値
_RATE_ENABLED	Trueで有効（既定False）	False
_RATE_WINDOW_MS	判定窓長	2000
_RATE_MAX_PER_WINDOW	1窓で許容する最大行数	60
_RATE_SUMMARY_EVERY	Drop件数がこの倍数の時に要約を出す	200

出力例
json
コードをコピーする
{"event":"dev.rate.dropped","level":"INFO","payload":{"sig":"dev.ui.test.bulk|DEBUG|audit_dev|dict|ui test bulk","dropped":200,"window_ms":2000}}
WARN/ERROR/CRIT は間引かれない。

---

## 5. ログビュー（log_ui.py）
表示仕様
項目	値
対象ファイル	logs/dev_audit.jsonl
表示期間	過去24時間
表示件数	最大50行（新しい順）
行高	固定10行（CSS制御）
時刻	JST変換表示
フィルタ	キーワード一致（event / feature / payload / level）
DL機能	JSONL（ts_jst付き）最大500行
Auto refresh	2 s間隔（ON/OFF切替可能）

---

## 6. UI構成（audit_ui.py）
### 6.1 モードトグル
OFF / DEBUG / BOOST を循環。

切替時に writer へ即反映。

BOOST へ入るとき auto_snap_on_boost がONならスナップショット自動生成。

### 6.2 スナップショット生成
種別	内容
LITE (DEBUG)	roots / env / log tail（20行）
FULL (BOOST)	上記＋env/version/files/audit_tail/config_digest/procs/DOM

出力はメモリ上 (st.session_state.snapshot_text)
DLボタンで handover_gpt.txt として保存。

### 6.3 付加オプション
キー	内容	既定
opt_repo_map	REPO_MAP抜粋を末尾へ追記	✅
opt_tail150	dev_audit.jsonl末尾150行を付加	☐
opt_env_versions	EnvとVersionsを追記	☐
opt_err_tail	Errors only tailを付加	✅
auto_snap_on_boost	BOOST突入時の自動スナップショット	☐

---

## 7. 運用ガイド
通常はOFF運用
問題解析・動作確認時のみ DEBUG または BOOST に切替。

BOOSTのログ量に注意
GPT提出用は _RATE_ENABLED=True 推奨。

スナップショット

BOOST時に手動ボタンまたは自動撮影で取得。

handover_gpt.txt にまとめて保存可。

ログのDL
log_ui.py 下部の「ログをダウンロード（JST・最大500行）」で取得。

ファイルサイズ管理
128 MB超過時は末尾32 MBのみ保持される。

---

## 8. 既知制限
マルチプロセス同時書き込みは portalocker 非導入環境では安全でない。

レート制御はプロセス単位（グローバル共有ではない）。

スナップショットはUIセッションに依存し、外部API経由での取得は未対応。

---

## 9. 今後の拡張候補
trace_id 自動付与（withコンテキスト）

例外キャプチャデコレータ @audit_exceptions

dev.rate.dropped 要約の可視化タブ

CI用 auditlint.py（壊れたJSON検知）

BtcTradeSystem V1 – Dev Audit Subsystem
Last updated: 2025-10-23