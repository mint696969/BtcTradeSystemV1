📘 BtcTradeSystem 開発監査仕様書（最終確定版）
version: 2025-10-19
author: mint777（設計） / GPT-5（仕様整理）

1. 開発監査の目的と役割

開発監査システムは、

「開発状態・環境・挙動を数値化・記録し、GPT との引継ぎ精度と問題解決効率を最大化する」
ことを目的とする。

主眼は「再現性」「整合性」「即応性」。
すなわち、誰が・いつ・どの環境で・どんな操作をしたかを正確に復元し、
チャットを跨いでも迷子にならない開発環境を維持する。

2. モード構成と動作
   モード 目的 ログ出力 スナップショット生成 備考
   OFF 通常運用・監査停止 なし なし 最軽量。生成抑止 通常運用。
   DEBUG 開発調整・通常観測 WARN 以上のみ Lite 開発時の普段使い。
   BOOST 詳細調査・デバッグ集中 すべて（DEBUG 含む） Full スナップショット自動生成＋ DOM プローブ 問題再現・解析用。

3. スナップショット設計
   3.1 出力種別
   名称 形式 サイズ目安 主な用途
   Lite Snapshot JSON / Markdown 8–16 KB 環境・主要ファイル・既知課題・次アクション
   Full Snapshot JSON / Markdown 30–60 KB Lite ＋ versions / probe / audit_tail
   Audit Tail JSONL 任意（末尾 50 ～ 200 行） 調査・再現支援
   3.2 共通フィールド（全スナップショット共通）
   {
   "ts": "2025-10-19T12:34:56.789Z",
   "mode": "BOOST",
   "repo_root": "C:\\Users\\mint777\\BtcTradeSystemV1",
   "paths": { "DATA": "D:\\BtcTS_V1\\data", "LOGS": "D:\\BtcTS_V1\\logs" },
   "focus_files": ["audit_ui.py","boost_svc.py","writer.py"],
   "run": {"port": 8501, "entry": "scripts/run.ps1"},
   "known_issues": [...],
   "next_actions": [...]
   }

3.3 Full Snapshot 追加要素

env_sanitized: 機密除去済み環境変数

versions: Python / Streamlit / 主要ライブラリ

files: サイズ・mtime 一覧

probe: DOM プローブ結果（selector 命中数・computed style）

audit_tail: 最新 200 行（自動カット）

プロセス一覧（pid/cpu/mem）

Python/Streamlit/OS ビルド

環境変数のダンプ（マスク付き）

config/settings.yaml のダイジェスト

3.4 DOM プローブ（常設）

BOOST モード時のみ実行。

指定セレクタの**命中数・スタイル値(bg/fg/border)**を収集。

結果は probe に格納、同時に dev_audit.jsonl に probe.\* イベントとして記録。

4. ログ（dev_audit.jsonl）の仕様
   4.1 出力制御
   モード 出力レベル 備考
   OFF 無効 emit 無効
   DEBUG WARN↑ 重要イベントのみ
   BOOST 全て 詳細記録
   4.2 共通フィールド
   {
   "ts": "2025-10-19T12:34:56.789Z",
   "mode": "BOOST",
   "level": "INFO",
   "feature": "audit_dev",
   "node": "main-pc",
   "proc": 12345,
   "trace_id": "bfy_20251019T123456Z_001",
   "component": "ui/audit",
   "event": "probe.snapshot",
   "payload": {"selector": ".mode-button","hits":3,"bg":"#333"},
   "payload_truncated": false
   }

4.3 ファセット拡張
区分 フィールド例 説明
Collector exchange, topic, lag_ms 取引所データ更新遅延など
API / Trade symbol, side, qty, latency_ms, status 発注 API の追跡
Model model_name, epoch, metrics AI 学習進捗
NAS / IO path, bytes, op NAS 書込・同期処理

4.4 サイズ制御と秘匿

payload_max_kb = 8 KB 超過時 → payload_truncated: true

API キー等は常にマスク。

JSONL は 128MB を超えると末尾 32MB のみ保持（原子的トリム）。

5. UI 挙動（監査タブ）
   5.1 モード切替時

DEBUG → Lite Snapshot 必要時手動生成

BOOST → Full Snapshot 必要時手動生成（DOM プローブ付き）

OFF → Snapshot 生成不可

生成結果を st.code() で表示

上部に Snapshot ⧉ Copy ボタン（クリックで内容をクリップボードへ）

チャットに貼り付ければ、そのまま GPT が解析できるフォーマット

5.2 監査ログ観測

Tail／Search／Filter／Group-by(trace_id, node)

Copy Lite：選択行＋要約（GPT 貼付用）

Copy Full：trace_id 関連行まとめ（調査用）

プリセット：API 失敗／Collector 遅延／モデル異常 等

6. 出力ファイル群
   ファイル 説明 サイズ/更新
   logs/dev_audit.jsonl 開発監査ログ本体 最大 128MB（トリム）
   logs/boost_snapshot.json 最新スナップショット ~50KB
   logs/handover_gpt.txt 引継ぎ用テキスト ~3KB
   logs/handover_lite.md（将来追加） GPT 初期読込用縮約版 ~5–8KB

7. サブプロセス連携とハンドオーバー生成

UI を経由せず、make_handoff.ps1（または tools/make_handover.py）から

from btc_trade_system.common import boost_svc
boost_svc.export_snapshot(force=True)
boost_svc.export_handover_text(force=True)

でヘッドレス生成可能。

この生成結果を handover.md に埋め込む／参照リンク化することで、
ダッシュボードの生成機能を不要化できる。

8. セキュリティと冪等性

API キー・秘密情報は常にマスク。

同一モード・短時間の再生成は抑止（冪等）。

ファイル上書きは原子的置換を使用し、破損防止。

生成失敗時は StreamlitAPIException を握りつぶさず、トレース全文を表示。

9. 将来拡張（互換保護）

Collector 専用 PC・NAS 対応

node フィールドで識別・集約

発注支援・自動売買

trace_id を貫通キーにし、API/Trade ログを統合

予測モデル学習

feature="model" として独立記録

AI 解析／学習ログ統合

各ログの Tail を GPT に直接貼付する運用に対応

ハンドオーバー自動整形

handover_lite.md 自動生成 → チャット開始時に貼るだけで文脈再構築

10. 追加機能概要

10.1 REPO_MAP 抜粋機能の追加

BOOST/DEBUG モードで生成される boost_snapshot.json 内の repo_map セクションから、各ファイル先頭コメント # path / # desc を抽出して整形表示。

抜粋数：DEBUG モードでは最大 50 件、BOOST モードでは最大 200 件を表示。

UI オプションとして「REPO_MAP 抜粋」チェックボックスを追加し、任意で handover 出力末尾へ付与可能。

抜粋内容は Markdown 形式で構成し、スナップショット handover 内に ## REPO_MAP (excerpt) として出力。

10.2 Errors only tail 機能の追加

dev_audit.jsonl の末尾 2000 行から、ERROR / CRITICAL / Traceback を含む行のみ抽出。

最大 150 行を出力上限とし、UI オプション「Errors only tail」（デフォルト ON）で handover に追加。

JSON 行・非 JSON 行の両方に対応し、安全なフォールバック処理を実装。

10.3 Config ダイジェスト機能の追加

config/settings.yaml または .yml の存在を検出し、以下情報を handover に付与：

ファイルパス、SHA256 ダイジェスト、ファイルサイズ、最終更新時刻。

設定ファイルが存在しない場合は (not found) と出力。

実行環境に依存しない簡易実装とし、スナップショット作成時の例外を吸収して UI 停止を防止。

10.4 Git 状態・StorageRouter 実体・ディスク空き容量の追加

git コマンドを用い、ブランチ名・コミット ID・dirty 状態を取得し handover に記録。

StorageRouter のログディレクトリ (logs_dir) とデータディレクトリ (data_dir) の存在・種別・更新時刻を確認。

各ディレクトリのドライブ単位でディスク使用量（total/used/free）を出力する \_disk_free_of() を新設。

これらはすべて BOOST モードで handover に付与される任意セクションとして組み込まれる。

10.5 UI の変更点

スナップショット表示窓を Streamlit の st.code() ベースに再設計。

コピーアイコンを自動表示。

常に 10 行分の高さを固定し、縦横スクロールを許可。

[[snapshot]] ラベルをウィンドウ内部先頭に含め、コピー対象にも含まれるよう統一。

CSS は snapshot_ui.py の ensure_snapshot_code_css() 内で注入し、二重適用を防止。

audit_ui.py 側では render_snapshot_code(display_txt) の 1 呼び出しで完結。

監査モード切替ボタン（OFF/DEBUG/BOOST）は従来通り。BOOST 遷移時に boost_snapshot.json を即時生成し、handover を UI 内部にロードする処理を追加。

新規チェックボックスオプション：

REPO_MAP 抜粋：REPO_MAP の要約付与。

audit_tail 150：末尾 150 行の監査ログ付与。

Env + Versions：環境変数と主要ライブラリバージョンを出力。

Errors only tail：ERROR/CRITICAL のみ抽出した tail を付与（デフォルト ON）。

11. 本日追加（仕様未記載）の開発監査機能差分（2025-10-22）

11.1 スナップショット先頭メタ情報の付与（ヘッダメタ）

目的: スナップショットの同定性・再現性向上（「いつ・どの状態で撮影したか」を一目で把握）。

追加項目（テキスト先頭に key: value で挿入）

snapshot_id（スナップショット JSON の SHA256）

created_utc（UTC, 秒精度）

mode（OFF/DEBUG/BOOST）

repo / branch / commit / dirty（Git 状態の要約）

logs_dir / data_dir（実体パス）

実装: features/audit_dev/snapshot_compose.py::build_header_meta()

11.2 Errors 要約ブロック（errors_summary）の追加

目的: 「どの程度壊れているか」を 2 行で把握。

出力例:

## errors_summary

- last_N: <N> counts: ERROR=<n>, CRIT=<n> top_event: <event>(<count>)

- range: <first_ts> .. <last_ts>（dev_audit.jsonl tail から推定）

実装: features/audit_dev/snapshot_compose.py::build_errors_summary()

11.3 REPO_MAP の重複排除（生成元＋表示の二段構え）

目的: 同一論理パス（大小文字/区切り差）による重複列挙を排除。

生成元: common/boost_svc.py で repo_map.items を path 正規化（lower + \→/） してユニーク化。total をユニーク件数に更新し、items は上限 300 件に制限。

表示側: features/audit_dev/snapshot_ui.py::repo_map_excerpt() でも保険としてユニーク化（既存 JSON を外部利用しても冪等）。

11.4 REPO_MAP 候補探索パスの拡張

目的: 実運用での REPO_MAP.extract.md 検出率を向上。

追加パス: data/ctx/REPO_MAP.extract.md を候補に追加（paths.data_dir()/"ctx"/REPO_MAP.extract.md）。

11.5 UI ミニメタバー（画面上部キャプション）の追加

目的: 撮影後すぐに同定情報を視認（貼付前の誤り防止）。

表示項目: id | utc | size | path | age（age は mtime からの経過秒）

備考: UI 本体の肥大化を避け、テキスト整形は audit_dev 側で実施。

11.6 内部スモークテストの整備（./tmp 配下）

tmp/dev_audit_smoke.py : writer 経由で INFO/ERROR を発報 → errors_only_tail() で抽出しヒット確認。

tmp/dev_snapshot_smoke.py : export_and_build_text(mode) の戻り（パス実在/テキスト長>0）を検証。DEBUG/BOOST 両方に対応。

目的: UI を介さずコア機能の健全性を短時間で確認。

11.7 writer I/F の正準化の明文化

目的: 監査書込み経路を features/audit_dev/writer.py に一本化（io_safe 直叩きを撲滅）。

推奨 API: audit_info(event, feature, \*\*kw), audit_error(...) ほか。モード制御は set_mode()/get_mode() をテストで併用。

11.8 repo_map 件数と上限制御の明確化

目的: handover/boost_snapshot の肥大化防止。

仕様: total はユニーク後の総件数、items は 最大 300 件 に制限（テキスト側の抜粋は既定 DEBUG=50 / BOOST=200）。

補足

11.1〜11.6 は 仕様書（v2025-10-19）未記載だったため、本日追補。

UI の高さ固定/スクロール安定化については一時検証を行ったが、UI の最終版はリストアポイントへ復帰済み（挙動は従来どおり）。

=============================================================

📑 開発ロードマップ（実装計画）
フェーズ 目的 / 対象 主な作業内容 優先
P1：基盤完成 現行機能を最終仕様へ ・モード切替時の Lite/Full 生成
・Copy ボタン実装
・DOM プローブ常設
・スナップショット上書き制御 ★★★★★
P2：ログ拡張 writer の汎用化 ・共通フィールド(node, trace_id...)追加
・payload サイズ/秘匿制御
・ファセット拡張 ★★★★☆
P3：監査タブ強化 観測・コピー体験向上 ・Filter/Search/Copy Lite/Full
・プリセットビュー追加 ★★★★☆
P4：ハンドオーバー連携 UI 外自動生成 ・handover_lite.md 自動生成
・handoff スクリプトへの統合 ★★★☆☆
P5：分散・NAS 対応 Collector/NAS 運用 ・node 識別統合
・NAS 同期ログ
・ローテ/圧縮設定 ★★★☆☆
P6：AI 学習統合 モデル/発注連携 ・feature="model"/"trade" ログ対応
・学習結果 metrics の要約出力 ★★☆☆☆
中核設計指針（チャットを跨いでも不変）

1 ファイル 1 キャンバス（現物コードのみ編集）

UI は観測・コピー中心、生成はサブプロセス

ファイルは増やさない／原子的上書き

モード OFF は沈黙、DEBUG は要点、BOOST は全記録

スナップショットと監査ログで全工程再現可能

ハンドオーバーは GPT ブート文書として常に最新を保つ

これが、現行方針の「開発監査仕様書（保存版）」です。
次の段階では、上記に基づいて実装ロードマップをタスク単位で細分化していきます（1 つずつ audit_ui.py → boost_svc.py → writer.py の順にキャンバス提案）。

実装ロードマップ（タスク分解）
P1. 基盤完成（モード切替で Lite/Full 生成＋コピー）【中核】
T1: モード切替 → スナップショット生成（Lite/Full）とレート制御

対象: btc_trade_system/features/dash/audit_ui.py

目的: DEBUG 切替 →Lite 生成、BOOST 切替 →Full 生成。同一モード N 秒以内の再生成を抑止。

DoD:

DEBUG/BOOST 切替で 1 回だけ生成され、同一モードで N 秒（例:10s）以内はスキップ。

生成物（文字列）は画面に**st.code()で表示**。

検証:

切替直後に表示が更新されること。

連打しても“スキップ”が効くこと（生成時刻が変わらない）。

T2: 「コピー」ボタン（クリップボード）実装

対象: audit_ui.py

目的: 生成結果の直下に小さなコピー（⧉）を設置。押下でクリップボードへ全文格納。

DoD:

ボタン 1 クリックで整形結果がコピーされ、チャットへそのまま貼れて崩れない。

検証:

実際にコピー → 新規メモ帳/チャットへ貼り付け、改行・インデントが保たれる。

T3: Lite/Full 整形関数の純粋実装

対象: btc_trade_system/common/boost_svc.py

目的: make_snapshot_lite(mode), make_snapshot_full(mode) を純粋関数として追加。ファイルは書かずに文字列/辞書を返す。

DoD:

戻り値が dict（JSON 化可能）か str（Markdown）で返ること。

ENV はマスク、サイズ上限（例: Lite 8–16KB / Full 30–60KB）を越えない。

検証:

PowerShell からヘッドレス実行し、print でサイズ・要素を確認。

T4: DOM プローブの常設（BOOST 限定）

対象: audit_ui.py（フロントで計測 → 結果 JSON）＋ boost_svc.py（受け取り合体）

目的: 指定セレクタの命中数＆computed style を probe フィールドに格納。BOOST 時だけ実行。

DoD:

probe.hits/bg/fg/border が Full Snapshot に含まれる。

失敗時は例外にしない（probe.ok=false とメッセージ）。

検証:

セレクタをわざとハズして hits=0 が出ること。

CSS 調整で hits/bg 等が変化すること。

T5: 既存ファイル上書きポリシーの確認（非保存デフォルトでも可）

対象: audit_ui.py・boost_svc.py

目的: 画面表示は非保存、必要時のみ上書き保存（logs/boost_snapshot.json）。

DoD:

既定はファイルが増えない（履歴を持たない）。

オプション ON 時のみ boost_snapshot.json を上書き。

検証:

ON/OFF の切替で LastWriteTime が制御どおり。

P2. 監査ログのフォーマット拡張（将来を見据えた最小拡張）
T6: 共通フィールド＋ facet ＋秘匿/サイズ制御

対象: btc_trade_system/features/audit_dev/writer.py

目的: emit 時に node/proc/trace_id/component を追加。payload_max_kb 超過で payload_truncated=true。

DoD:

JSONL に新フィールドが出力される（OFF は無出力／DEBUG は WARN↑／BOOST は全件）。

大きい payload で安全にトリムされる。

検証:

疑似大 payload でトリムフラグが立つ。

128MB 超 →32MB 残し（既存ポリシー）が動作。

P3. 監査タブの観測・コピー体験
T7: フィルタ/検索/グルーピング（trace_id/node）

対象: audit_ui.py

目的: Tail 追従／期間検索／trace_id / node でグルーピング表示。

DoD:

条件指定で該当行のみ表示。

グループビューでイベントのまとまりを把握できる。

検証:

フィルタ条件の切替で即時反映。

T8: Copy Lite / Copy Full（整形テンプレ）

対象: audit_ui.py

目的: 選択行から GPT 貼付用の要約（Lite）と関連まとめ（Full）を生成してコピー可能に。

DoD:

Lite は 1〜2KB で収まり、要点（いつ/どこ/何を）が揃う。

Full は trace_id で関連行をまとめ、1 クリックコピーできる。

検証:

貼り付けた文面で GPT に再現/分析を即依頼可能。

P4. ハンドオーバー連携（UI 外・ヘッドレス）
T9: handoff スクリプトでのヘッドレス生成

対象: scripts/make_handoff.ps1（新規 or 既存）、tools/make_handover.py（任意）

目的: export_snapshot()/export_handover_text() を UI なしで実行。stdout に出すオプションも用意。

DoD:

コマンド一発で handover 一式が更新される。

エラー時は非ゼロ終了コード＋ stderr に要因出力。

検証:

PowerShell で PYTHONPATH 設定 → スクリプト実行 →LastWriteTime 更新。

T10: handover_lite.md の自動生成（GPT 初期読込用）

対象: boost_svc.py（整形関数）、tools/make_handover.py（生成）

目的: 8KB 以内の Markdown 要約（DATA/LOGS/起動/課題/次アクション）を生成。

DoD:

docs/handoff/handover_lite.md が常に最新。

5 問チェック（読み合わせ）の冒頭テンプレ付き。

検証:

実ファイルのサイズ/内容を確認。GPT に貼って初期質問に答えられる。

P5. 分散/NAS 対応（必要時）
T11: node 識別＆NAS I/O ログ

対象: writer.py・boost_svc.py

目的: node を PC 役割名で出力、NAS I/O を op/path/bytes で記録。

DoD:

複数 PC のログを単一 JSONL に集めても識別できる。

検証:

main-pc/collector-pc で識別される。

P6. AI 学習/発注/Collector 拡張（任意）
T12: feature 別 facet の最小導入

対象: 関連モジュールの emit 呼び出し箇所

目的: feature="model"|"trade"|"collector" の場面で専用フィールドを付与。

DoD:

該当イベントが facet 付きで記録。

検証:

UI のフィルタで目的の行が抽出できる。

実施順・所要感（推奨）

P1（T1〜T5）：中核を一気通し（最優先）

P2（T6）：ログを将来互換化

P3（T7〜T8）：観測とコピー体験を整える

P4（T9〜T10）：ヘッドレス連携と handover_lite

P5・P6：必要に応じて順次

並行可：T3（整形関数）→T1/T2、T6→T7/T8

受け入れ基準（総合）

DEBUG/BOOST 切替で 画面に整形スナップショット＋コピーが必ず出る

ファイルは増えない（既定）；履歴は手動時のみ

dev_audit.jsonl は 128MB→32MB 保持（既存 OK）

DOM プローブ が Full に含まれ、CSS 問題時に hits=0 などが数値で観測できる

handoff スクリプトで UI なし生成が完了

handover_lite.md をチャット冒頭に貼るだけで、初期質問に答えられる

よく使う検証コマンド（PowerShell）

# ルート & PYTHONPATH

Set-Location $env:USERPROFILE\BtcTradeSystemV1
$env:PYTHONPATH = (Get-Location).Path
$py = ".\.venv\Scripts\python.exe"; if(-not(Test-Path $py)){ $py = "python" }

# 生成をヘッドレス確認

& $py -c "from btc_trade_system.common import boost_svc as b; \
print('LITE:', len(b.make_snapshot_lite('DEBUG'))); \
print('FULL:', len(b.make_snapshot_full('BOOST')))"

# 出力ファイルの更新確認

$L='D:\BtcTS_V1\logs'
Get-Item "$L\boost_snapshot.json","$L\handover_gpt.txt" -ErrorAction SilentlyContinue |
Select-Object Name,Length,LastWriteTime

# dev_audit サイズ確認

Get-Item "$L\dev_audit.jsonl" | Select-Object Length,LastWriteTime

リスクと回避

多重生成：セッションに last_snapshot_mode/ts を持ち N 秒抑止

機密漏えい：ENV はホワイトリスト＆マスク、payload 縮約

巨大ログ：既存のトリム＋日次ローテ（必要時）

UI 例外：更新 → 即 st.rerun()、例外はフルトレース表示で握り潰さない
