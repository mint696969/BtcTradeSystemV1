# 開発監査スナップショット仕様書

## 1. 概要

本仕様書は、BtcTradeSystemV1 における **開発監査（Dev Audit）スナップショット機能**の構造、役割、使用方法を定義する。スナップショット機能は、開発時のシステム状態・環境情報・監査ログ・リポジトリ構成を即座に保存し、問題解析や GPT 引継ぎ用のハンドオーバーテキストとして活用できる仕組みである。

---

## 2. スナップショット機能の目的

- 開発・検証中の状態を**瞬時に再現可能な形**で保存。
- 障害や異常時の**即時デバッグ支援**。
- **開発監査（Dev Audit）**との統合により、行動履歴や内部イベントを同一タイムライン上で追跡可能。
- GPT・人間問わず、第三者に状態を**正確に引き渡す**ための Handover テキスト出力。

---

## 3. 主構成ファイル

| ファイル                                 | 役割                                                                                  |
| ---------------------------------------- | ------------------------------------------------------------------------------------- |
| `common/boost_svc.py`                    | スナップショットの生成および handover テキスト出力ロジックの中核。                    |
| `features/audit_dev/snapshot_ui.py`      | Streamlit 上でのスナップショット表示ウインドウ描画および CSS 管理。                   |
| `features/audit_dev/snapshot_compose.py` | スナップショットテキスト構築の補助。メタ情報、errors_summary、REPO_MAP 生成を担当。   |
| `features/audit_dev/writer.py`           | 監査ログの公式書込みインターフェース（audit_event / audit_info / audit_error など）。 |
| `features/dash/audit_ui.py`              | UI トリガー部。トグル操作や Snapshot ボタンの呼び出し管理。                           |

---

## 4. スナップショット構造（boost_snapshot.json）

スナップショットは `logs/boost_snapshot.json` に JSON 形式で保存され、以下の主な構成を持つ：

| キー              | 説明                                                                     |
| ----------------- | ------------------------------------------------------------------------ |
| `ts`              | UTC 時刻（ISO8601）                                                      |
| `mode`            | DEBUG / BOOST                                                            |
| `roots`           | data/logs/repo 各ルートパス                                              |
| `env`             | 環境変数情報（BTC_TS_MODE など）                                         |
| `versions`        | Python / OS / Streamlit などの環境バージョン情報                         |
| `files`           | 主要ログファイル（audit.jsonl / dev_audit.jsonl / handover_gpt.txt）情報 |
| `settings_digest` | `config/settings.yaml` の存在とハッシュダイジェスト                      |
| `recent`          | 監査ログの末尾（tail）および ERROR/CRIT 抽出結果                         |
| `repo_map`        | リポジトリ構造の抜粋 (#path/#desc)                                       |
| `processes_top`   | 実行中プロセス上位（BOOST のみ）                                         |
| `tree`            | data/logs ディレクトリの薄いツリー情報（BOOST のみ）                     |

---

## 5. 出力ファイル

| 出力ファイル               | 内容                                               |
| -------------------------- | -------------------------------------------------- |
| `logs/boost_snapshot.json` | スナップショットデータ（構造・環境・監査ログなど） |
| `logs/handover_gpt.txt`    | GPT / 引継ぎ用のテキスト整形済みスナップショット   |

### Handover テキスト構造（簡略）

```
# BtcTradeSystemV1 Handover (BOOST)
- ts: 2025-10-22T13:04:59Z
## Roots
## Env
### Versions
### Files (logs)
### config/settings.yaml (digest)
## Loaded modules (BOOSTのみ)
## REPO_MAP (excerpt)
## Errors & Critical (recent)
## Recent dev_audit tail
## Processes (BOOSTのみ)
## How to reproduce (PowerShell)
```

---

## 6. UI 動作仕様

### モードトグル

- OFF / DEBUG / BOOST の 3 段階。
- モードはセッション内のみ保持（再起動時リセット）。
- BOOST 選択時はスナップショット生成（`export_snapshot(force=True)`）を自動実行。

### スナップショット表示ウインドウ

- Streamlit で常時 10 行固定・縦横スクロール可能なコード枠を表示。
- 空時でもボックスを維持（UI 崩壊防止）。
- 内容は `render_snapshot_code(text)` により描画。

---

## 7. 付随機能

- `errors_summary`: dev_audit.jsonl の末尾 150 行から ERROR/CRIT 件数と範囲を算出。
- `repo_map_excerpt`: REPO_MAP.extract.md 抜粋。重複排除済み。
- `writer` モジュール経由で統一フォーマットで監査ログを追加。
- DEBUG: 軽量出力（モジュールリスト/プロセス省略） BOOST: フル情報出力。

---

## 8. 使用方法

1. **ダッシュボードの Audit タブを開く。**
2. **モードトグルを切替（DEBUG または BOOST）。**
3. **「Snapshot」ボタンをクリック。**

   - `boost_svc.export_snapshot()` が呼び出され、スナップショット JSON が生成。
   - 直後に `handover_gpt.txt` が出力。

4. **UI 下部に出力されるテキスト枠**から内容をコピーして GPT へ転送可。

---

## 9. エラー処理と安全設計

- 書込みはすべて `io_safe.write_atomic()` により原子的上書き。
- スナップショット生成は 10 秒以内の再実行を抑制（RATE 制御）。
- 書込み失敗時は `.tmp` へ退避し再試行。

---

## 10. 拡張予定

- 差分比較ビュー（複数スナップショット間の比較）。
- メタバー拡張（branch / commit の追加）。
- REPO_MAP の自動更新と REPO 構造監査との統合。

---

## 付録：関連テストスクリプト

| ファイル                    | 内容                                          |
| --------------------------- | --------------------------------------------- |
| `tmp/dev_audit_smoke.py`    | 監査ログ書込みテスト（INFO/ERROR を記録）。   |
| `tmp/dev_snapshot_smoke.py` | スナップショット生成・handover テキスト検証。 |

---

## 付録：BOOST／DEBUG モード差異一覧

| 項目                    | DEBUG                      | BOOST                                |
| ----------------------- | -------------------------- | ------------------------------------ |
| スナップショット出力    | LITE（軽量）               | FULL（詳細）                         |
| REPO_MAP 出力           | 最大 50 件                 | 最大 200 件（内部保持 300 件）       |
| data/logs ツリー情報    | 省略                       | 出力（最大深度 2, 最大 200 件）      |
| モジュールリスト        | 省略                       | 最大 1000 件（表示は 50 件）         |
| プロセス情報            | 省略                       | psutil により上位 20 プロセスを出力  |
| dev_audit_tail 行数     | 20                         | 100                                  |
| audit_tail 行数         | 20                         | 50                                   |
| dev_audit_err_tail 行数 | 20                         | 100                                  |
| audit_err_tail 行数     | 20                         | 50                                   |
| REPO_MAP 重複排除       | 共通実装（path 正規化）    |                                      |
| Handover テキスト出力   | 生成対象外（JSON のみ）    | JSON + handover_gpt.txt 同時出力     |
| UI 自動スナップショット | トグル切替時に実行されない | トグル切替時に強制実行（force=True） |
| 出力目的                | 開発中の軽量検証・動作確認 | リリース直前・詳細調査・GPT 引継ぎ用 |

---

**作成日:** 2025-10-22
**作成者:** 開発監査チーム（BtcTradeSystemV1）
