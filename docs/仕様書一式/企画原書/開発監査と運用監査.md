🔧 開発監査（Development Audit）
■ 概要

開発者がシステム挙動を検証・分析・引き継ぐための内部監査モード。
運用監査とは完全に分離され、UI 上でも明確に切り替えられる。
目的は「開発時の状態理解と引き継ぎ支援」であり、実運用データや顧客行動には影響しない。

■ モード構造

開発監査には 3 つの状態がある：

モード 説明 出力範囲 色
OFF 監査出力停止。開発中以外の時に使用 無出力 灰色
DEBUG 通常デバッグ用。重要イベントと WARN 以上を記録 フィルタあり 黄色
BOOST 詳細出力（全イベント＋自己説明スナップショット） フル出力 赤色

BOOST は ChatGPT が途中引継ぎ時に必要な全情報を吐き出す「自己説明モード」。
→ 現行状態・モジュール一覧・監査末尾などを boost_snapshot.json にまとめる。
→ これにより、別セッション GPT が即座に開発状態を再現可能。

■ モード制御の仕組み
内部

features/audit_dev/writer.py 内の \_MODE 変数（プロセス内一意）。

set_mode() と get_mode() により UI と同期。

\_MODE は非永続。ダッシュボード起動時は必ず OFF から始まる。

UI トグル

「監査ログ（dev_audit.jsonl）」の左上にボタン 1 つ。

クリックするたびに OFF → DEBUG → BOOST → OFF を循環。

背景色は状態に応じて灰／黄／赤。

ボタン自体がスイッチであり、歯車や別設定パネルとは独立。

■ 出力対象と保持方針
ファイル

logs/dev_audit.jsonl に書き込み（JSONL 形式）

単一ファイル運用（世代管理しない）

サイズ上限は 128MB。
超過時は末尾 32MB のみ残し、原子的置換でトリム（高耐久構造）。

書き込み内容（1 行構造）
{
"ts": "UTC 時刻",
"mode": "BOOST",
"event": "dev.boost.info",
"feature": "audit_dev",
"level": "INFO",
"actor": "tester",
"site": "local",
"session": "S-DEV",
"task": "dev.audit",
"trace_id": "DEV-TRACE-001",
"payload": {...}
}

BOOST 時の追加出力

btc_trade_system/common/boost_svc.py にてスナップショット生成。
出力ファイル: logs/boost_snapshot.json

含まれる情報：

ルートディレクトリ構成（data/logs）

ロード済みモジュール一覧

audit/dev_audit の末尾 50 行

実行環境情報（BTC_TS_MODE, PYTHONPATH など）

更新間隔：10 秒以上経過している場合のみ（自動レート制御）

■ UI の設計と動作
構成

タイトル横にスイッチボタン（OFF/DEBUG/BOOST）

フィルタ群：

キーワード（event/feature/payload など部分一致）

レベル（ALL/INFO/WARN/ERROR/CRIT）

exchange / component / 件数（200/500/1000）

表示ロジック

audit_svc.get_audit_rows() で行取得

exchange/component は現状 UI 側でフィルタ

DataFrame を整形：

優先列順（ts, level, feature, event, exchange, …, payload）

数値列は Int64 化

payload は dict/list を JSON 文字列化

見た目仕様

列幅可変 (width="stretch")

折り返し禁止

「開発監査ログ（dev_audit.jsonl）」タイトルはトグルと中央揃えで横並び

Tail コマンド例をサブテキストで表示

■ BOOST モードの目的

BOOST は単なるデバッグ詳細ではなく、チャット間引継ぎ補助を目的とする。

機能

実行中の全モジュールリスト化

ログ・データの直近状態をスナップショットに保存

再開時にこの snapshot を GPT が読むことで、
前回の開発状態・文脈を再構築可能

■ 目的まとめ
項目 目的
開発監査 開発者が安全に挙動を観測・調整するため
BOOST GPT 間での引継ぎ・再現性の確保
DEBUG 通常デバッグ・挙動確認
OFF パフォーマンス・安定運用
スナップショット 状態の自動説明書化
🧭 運用監査（Operational Audit）
■ 概要

本番運用・障害解析・稼働健全性の記録を目的とした標準監査。
collector や board など全コンポーネントの動作履歴を時系列で蓄積。

■ 監査モード

BTC_TS_MODE 環境変数で切替：

モード 出力範囲 主な用途
PROD 重大系のみ（ERROR/CRIT） 本番運用時
DEBUG WARN 以上 + 特定 INFO 検証・リハ環境
DIAG すべて 深堀り解析
補足

collector 側や core 処理も should_emit() により自動ゲートされる。

重大遷移、開始/停止イベント、レートリミット、再試行などは常に採取。

■ 出力仕様

ファイル: logs/audit.jsonl

StorageRouter 経由で、ローカル + 共有ストレージへ同時書込

フォールバック: Router 失敗時のみローカル追記

JSON 構造は dev_audit.jsonl と同様だが、モードは PROD/DEBUG/DIAG

■ マスキングと要約

\_redact() により secret/token/password/apikey を自動マスク

\_truncate_payload() によりモード別上限で短縮

PROD: 1KB

DEBUG: 2KB

DIAG: 8KB
→ \_preview と \_orig_bytes フィールドを付与

■ 関連ファイル
目的 ファイル 担当
監査出力共通 common/audit.py 運用監査コア
開発監査出力 features/audit_dev/writer.py 開発監査専用
BOOST スナップショット common/boost_svc.py 自己説明・環境保存
UI 描画 features/dash/audit_ui.py 開発専用タブ
運用健全性 UI features/dash/health_ui.py 通常稼働監査
■ 将来的な統合イメージ

運用監査は「健全性」タブ内に統合（常時表示）

異常（WARN 以上）が検知された場合、下方にスクロールして詳細原因（audit.jsonl 解析）を表示

開発監査とは UI 層も機能も分離：運用は常時、開発は任意

■ 両監査の関係と設計哲学
項目 開発監査 運用監査
モード制御 UI ボタン循環（OFF/DEBUG/BOOST） 環境変数（BTC_TS_MODE）
出力ファイル dev_audit.jsonl audit.jsonl
保存方針 1 ファイル固定＋自動トリム 世代運用可
出力条件 \_dev_should_emit() should_emit()
UI 位置 監査タブ（開発専用） 健全性タブ下段
用途 開発・検証・GPT 引継ぎ 本番監視・保守
表示色 灰/黄/赤 常時（色変化なし）
■ 狙いと意義

開発と運用を完全分離し、重くならないデバッグと軽い安定運用を両立。

GPT を含む引継ぎプロセスに一貫した情報を残すことで、セッションを跨いでも迷子にならない。

監査ログ自体が「開発知能の記憶」として機能。
