# 2-3 機能分離リポ再設計・実装予定.md

## 19. UI 設定タブ 仕様（確定ドラフト / 2025-10-12）

**目的**: コードに手を入れず“設定だけで運用”を実現。追加・削除・並び替え・復元・テストが UI で完結。

### 19.1 画面構成（タブ内サブタブ）

- **Exchanges**（取引所）
- **Network**（通信）
- **Paths**（保存先）
- **Appearance**（見た目）
- **Audit/Mode**（監査・モード）
- **Backup/Reset**（バックアップ・復元）

> すべて **読み取りは package 内 config**、**機密書込みは `<SECRETS_ROOT>`** に固定。

### 19.2 Exchanges（取引所）

**一覧パネル**

- 行要素: `handle`（並び替え）/ `enabled` / `key` / `label` / `type` / `notes` / アクション（✎ 編集 / ⊕ 追加 / 🗑 無効）
- 並び替え：D&D → `config/exchanges/registry.yaml.order` を更新

**詳細パネル**（選択行の編集）

- 基本: `key`, `label`, `types`, `notes`
- レート: `rest.global(capacity, refill_per_*)`, `groups`, `ws.send.min_interval_ms`
- エンドポイント: `rest_base`, `ws_base`
- **API 鍵**（Secrets）：`api_key`, `api_secret`, `passphrase`（保存先は `<SECRETS_ROOT>/exchanges.secrets.yaml`）
- テスト: `疎通`（HTTP/WS） / `自動取得`（Retry-After, usage header） / `保存`
- 反映: `registry.yaml` の `enabled/overrides/order`、Secrets は別書込み

**操作の結果**は `audit.jsonl` に `settings.exchanges.{add|update|reorder|toggle}` を記録（actor/site/session/keys）。

### 19.3 Network（通信）

- **優先**: `net_pref` = `ipv4` / `ipv6` / `auto`（既定は `ipv4`）
- **Timeouts**: `connect_ms`, `read_ms`, `total_ms`
- **Retry/Backoff**: `max_retries`, `strategy`=`fixed|expo|server`, `base_ms`, `max_ms`
- **Proxy**（任意）: `http_proxy`, `https_proxy`（空なら未使用）
- **TLS**: `verify=true/false`（false は警告表示）
- テストボタン：「全エンドポイント疎通」（診断結果をトースト表示 → 必要なら `scripts/diag/` 推奨）

### 19.4 Paths（保存先）

- 参照優先：引数 → ENV（`BTC_TS_*`）→ 既定。UI では現在値を**表示のみ**（編集不可）。
- 表示項目：`data_dir`, `logs_dir`, `models_dir`, `artifacts_dir`, `secrets_dir`
- ボタン：`開く`（Explorer/ファイラ起動）／`コピー`（パスをクリップボード）

### 19.5 Appearance（見た目）

- テーマ（light/dark/system）、表のデフォルト行数、日時表記（ローカル/UTC）
- 言語（`config/i18n_ja.json` を参照）。**キーは短名固定**（signals_history_title 等）

### 19.6 Audit/Mode（監査・モード）

- 表示のみ：`BTC_TS_MODE`（ENV）
- モード拡張の表示：`actor`, `site`, `session`, `task`（ENV/起動時注入）
- 監査ビューへのジャンプ（直近の設定変更ログを開く）

### 19.7 Backup/Reset（バックアップ・復元）

- **バックアップ**：`config/` と `ui/` を ZIP（`logs/audit.jsonl` に記録）
- **スナップショット**：`config/snapshots/yyyymmdd-HHmm.yaml` を作成
- **復元**：`ui` のみ復元／`exchanges` 既定へ戻す（**二段階**で誤爆防止）

### 19.8 バリデーション / エラー表示

- 入力時に pydantic で即時検証（key の一意／数値範囲／URL 形式）
- 保存前に差分プレビュー（左右比較）。保存後はトースト＋監査記録

### 19.9 キーボード / アクセシビリティ

- `Ctrl+S` 保存、`Ctrl+Z` 取り消し、`Ctrl+Y` やり直し
- Tab 移動、Enter でトグル、スクリーンリーダー対応ラベル

### 19.10 実装メモ（app/core 分離）

- **app**（Streamlit）: ページ・フォーム・テーブル・診断の UI のみ
- **core**: `svc_settings.py`（読込/マージ/検証/保存）、`svc_secrets.py`（別書込み）、`svc_test.py`（疎通）
- **依存方向**: app → core → common（paths, audit, schemas）

### 19.11 ファイル例（短名・2 行ヘッダ）

```python
# path: features/dash/app/ui_settings.py
# desc: 設定タブの画面。Exchanges/Network/Paths/Appearance/Audit/BackupのUI。

# path: features/dash/core/svc_settings.py
# desc: 設定の読み書き・マージ・検証（defaults/registry/ui と secrets）
```

> この仕様に従い、UI から“追加・削除・並び替え・鍵管理・復元・診断”が完結する。コード変更なしで運用可能。

---

## 20. 言語方針と配布・運用前提（確定 / 2025-10-12）

### 20.1 言語方針

- **ドキュメント／キャンバス／仕様書**：すべて日本語で記述。
- **コード（関数名・変数・ファイル名など）**：英語の短名で統一。
- **コード内コメント／docstring**：必要に応じ日本語を併記（英語のみでも可）。
- **UI 表示文言**：日本語表記を基本とし、`config/i18n_ja.json` にキーと翻訳文字列を集約。将来的に他言語追加が可能な構成を維持。

### 20.2 配布・運用前提

- 本パッケージは **外部配布を前提としない（自家運用専用）**。
- ただし以下のケースでの再配置・環境移行を想定：

  1. **開発 PC の変更**（例：ノート PC → デスクトップ）
  2. **新規 PC への載せ替え**（例：OS 再インストールや新環境構築）
  3. **本番運用 PC の変更**（例：テスト用 → 常時稼働用）

- これらのケースでは、`config/`・`secrets/`・`data/`・`logs/`・`models/`・`artifacts/` の外出しフォルダをそのままコピーするだけで再現できる設計を保持する。
- **依存関係**：Python 環境と PowerShell スクリプトのみで完結（Docker 等の外部依存は現時点で不要）。

### 20.3 バックアップと復元方針

- 主要フォルダ（`config/`, `ui/`, `secrets/`, `logs/`, `data/`）を定期的にバックアップ。
- `tools/backup_config.ps1` により ZIP 化（暗号化オプション付き）して保存可能。
- 新環境への移行時は、フォルダ構造を保ったまま展開すれば即稼働可能。

> この章をもって、日本語表記と自家運用方針を公式に確定。以後すべての仕様記述は日本語で行う。

---

## 21. 監査モードと健全性（緑/黄/赤）—設計確定 / 2025-10-12

**目的**: 「本当に壊れているのか」「上流遮断なのか」を即判定し、再発時も迷子にならない。モードに応じて監査の粒度と負荷を制御する。

### 21.1 モード定義（ENV: `BTC_TS_MODE`）

- **緑（運用）= `PROD`**: 最小限の監査。性能最優先。
- **黄（開発）= `DEBUG`**: 主要 I/F を広く記録。問題の当たりを付けられる粒度。
- **赤（原因特定）= `DIAG`**: すべての行動を詳細記録。短時間のみ使用。

※ 起動時に `actor/site/session/task` を注入（ENV または入口で自動生成）。全イベントに付与する。

### 21.2 監査イベントの最小セット（共通フィールド）

- 共通: `event, ts, level, feature, mode, actor, site, session, task`
- 追加: `source_file, line_hint, payload`（任意）
- 失敗時: `exc_type, message, file, lineno, stack_hash`
- 保存先: `logs/audit.jsonl`（ローテ: 日次, 100MB 超で分割）

### 21.3 粒度とサンプリング（緑/黄/赤）

| 区分             | 緑 (PROD)        | 黄 (DEBUG)             | 赤 (DIAG)                  |
| ---------------- | ---------------- | ---------------------- | -------------------------- |
| 起動/終了        | ✔                | ✔                      | ✔                          |
| 設定読込/保存    | ✔(要点のみ)      | ✔(差分含む)            | ✔(全文スナップ)            |
| HTTP/WS 成功     | ✖(集計のみ)      | △(1/N サンプル)        | ✔(全件: ヘッダ要約)        |
| HTTP/WS 失敗     | ✔(要点)          | ✔(要点+レスポンス断片) | ✔(本文/ヘッダ/再試行詳細)  |
| 書込(file.write) | ✔(パス/サイズ)   | ✔(パス/サイズ/所要 ms) | ✔(書込前後ハッシュ)        |
| 正規化/特徴量    | ✖                | △(集計)                | ✔(入力/出力の件数・例外行) |
| レート制御       | ✔(待機 ms/scope) | ✔                      | ✔(トークン残量/復帰まで)   |
| 健全性集計       | ✔                | ✔                      | ✔(根拠ファイルまで列挙)    |

> `1/N サンプル` は既定 1/100（UI で変更可）。

### 21.4 健全性の判定（外因/内因を分ける）

- **外因 (External)**: `SRC_DOWN`(上流停止), `NET_BLOCK`(FW/Proxy), `AUTH_FAIL`(鍵/権限), `RATE_LIMIT`(429), `DNS_FAIL`
- **内因 (Internal)**: `PARSE_ERR`(パース), `WRITE_ERR`(書込), `NORMALIZE_ERR`, `LOCK_STALE`, `EXC_UNHANDLED`
- 判定根拠: `data/collector/status.json` を第一優先。なければ `latest/raw` の mtime と監査イベントから推定。
- UI 表示: カードに **原因種別/最終成功時刻/連続失敗回数/推奨アクション** を表示。

### 21.5 フレッシュネス（freshness）とギャップ検出

- `ts_recv` の連続性を監視（ギャップ閾値: topic 既定 ×3）。
- `latency_ms` の移動中央値 ×K を超えたら WARN。
- 直近 `N` 分の **件数/サイズ/エラー率** を滑らかに可視化（UI: sparklines）。

### 21.6 ファイル規約（ノイズ最小 / 復元性）

- `data/raw/<ex>/<topic>/YYYYMMDD/*.jsonl` …… 生値（損失なし）
- `data/latest/<ex>-<topic>.csv` …… UI 用スナップショット（最小スキーマ/UTC ms/空セル NULL）
- 書込は **一時ファイル → アトミックリネーム**。CSV は `UTF-8, newline="", QUOTE_MINIMAL`。

### 21.7 監査ビュー（UI 連携）

- 直近 `N` 分のイベントを **mode/feature/cause** でフィルタ。`session` で時系列追跡。
- クリックで **根拠ファイル**（raw/最新/ログ）へジャンプ（パスを表示・コピー）。

### 21.8 運用ガイド

- 緑（PROD）常用。異常検知 → 黄に引上げ（短時間）。不明瞭なら赤で **時間を決めて** 収集、終わったら即緑に戻す。
- 赤使用時は **ローテ/容量監視**を強制有効化。

> この章は「v0 の疑念」を解消するための基準。以後、Collector の実装やテストは本定義に適合させる。

---

## 22. ログ／監査／データの保存規約（確定 / 2025-10-12）

### 22.1 保存場所の基準

| 区分                     | 保存先                                                                | 内容                                   |
| ------------------------ | --------------------------------------------------------------------- | -------------------------------------- |
| **監査ログ**             | `logs/audit.jsonl`                                                    | イベント単位の監査情報（モード別粒度） |
| **Collector ログ**       | `logs/collector/YYYYMMDD.out.log` / `logs/collector/YYYYMMDD.err.log` | 起動・例外・統計など                   |
| **Dashboard ログ**       | `logs/dashboard/YYYYMMDD.out.log` / `logs/dashboard/YYYYMMDD.err.log` | UI 側エラー・操作記録                  |
| **健全性状態**           | `data/collector/status.json`                                          | 各取引所の状態（外因/内因区別付き）    |
| **生データ（raw）**      | `data/raw/<exchange>/<topic>/YYYYMMDD/*.jsonl`                        | 元 API レスポンスの損失なし記録        |
| **最新データ（latest）** | `data/latest/<exchange>-<topic>.csv`                                  | 最新スナップショット（UI 表示用）      |
| **特徴量／学習データ**   | `data/features/*.csv`                                                 | 学習・解析用に整形済みデータ           |

### 22.2 書き込み方式（破損防止 / Kill 耐性）

- **CSV/JSON（一括置換系）**：`*.tmp` に全書込 →`flush`→`fsync`→`os.replace(tmp, final)`（原子的）
- **JSONL/監査（追記系）**：行単位で `write + flush + fsync`。半行発生時は次回起動の修復で切り落とし。
- **ファイルロック**：書込時は排他ロック（`pid, started_at, session` を記録）。

### 22.3 起動時プリフライト（自動修復）

- ロック掃除：`data/locks/*.lock` の stale を解放
- tmp 掃除：`*.tmp` を削除（または再適用）
- 監査修復：`audit*.jsonl` 末尾の不完全行を truncate
- raw 整合：最終ファイルの末尾改行を保証（なければ追加/切詰）
- latest 整合：ハッシュ/サイズ異常があれば raw から再生成

### 22.4 ローテーション（**日別ファイル化**＋アーカイブ）

- **監査**：`logs/audit.jsonl` は**日次でローテ**し、前日分を `logs/archive/audit-YYYYMMDD.jsonl.gz` に圧縮退避。
- **Collector/Dashboard**：`YYYYMMDD.out/err.log` を日次生成。**サイズ 50MB 超**でスプリットし、古い分を `logs/archive/*.gz` へ圧縮退避。
- **raw**：日付ディレクトリ単位。**保持は無期限**（デフォルト）。容量が逼迫する場合のみ方針 22.6 へ従う。
- **latest**：上書き保持（過去は raw から復元可能）。

### 22.5 スナップショット／バックアップ

- 0 時に `config/`・`data/latest/`・`logs/audit.jsonl` のコピーを `snapshots/YYYYMMDD/` に作成。
- `ops/collector/logrotate.ps1` が同時に古いログを圧縮・アーカイブへ移動。

### 22.6 アーカイブと保存年限（**捨てない方針**）

- 原則として**学習価値があるデータ（raw/監査）は削除しない**。
- 容量対策は削除ではなく**圧縮＋階層化**で対応：

  - `logs/archive/` … 過去ログ（`.gz`）
  - `data/archive/raw/<exchange>/<topic>/YYYY/MM/` … 月ごとに `*.jsonl.gz` へ **連結圧縮**（任意運用）

- 長期保存の目安：最低 **2 年**、可能なら無期限。
- 必要に応じて**外付けドライブ/クラウドストレージ**へアーカイブを移送（`tools/backup_config.ps1` で対応）。

### 22.7 データ整合チェック

- 起動時：`latest`↔`raw` ハッシュ照合／`status.json` の `last_ok` と突合。
- 夜間バッチ：`ops/collector/health.ps1` でファイル件数・欠損・破損を検査。異常時は `audit.jsonl` に `audit.repair` を記録。

### 22.8 監査イベント例（再掲）

```json
{
  "ts": "2025-10-12T09:15:32.456Z",
  "mode": "DEBUG",
  "event": "collector.write",
  "feature": "collector",
  "actor": "mint777",
  "site": "devPC",
  "session": "20251012-0915-ABCD",
  "task": "okx.trades",
  "level": "INFO",
  "source_file": "okx_trades_worker.py",
  "line_hint": 220,
  "payload": { "rows": 154, "bytes": 19844, "elapsed_ms": 42 }
}
```

> 本章は「日別ファイル化するか？」「多すぎるログはどうするか？」への回答を含む最終規約。**削除ではなく圧縮アーカイブ**が原則。

---
