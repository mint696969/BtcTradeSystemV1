# path: ./btc_trade_system/features/settings/settings.py
# desc: è¨­å®šã‚¿ãƒ–ã®UIæœ¬ä½“ï¼ˆmonitoring.yaml ã®é–²è¦§/ä¿å­˜ã‚„é…è‰²ã®ä»Šå›ã®ã¿é©ç”¨ã‚’æä¾›ï¼‰

from __future__ import annotations
import json
import os
from typing import Any, Callable, Tuple

# dev_audit è¨˜éŒ²
from btc_trade_system.features.audit_dev import writer as W

# --- streamlitï¼ˆç„¡ã‘ã‚Œã°ãƒ€ãƒŸãƒ¼ã§å´©ã‚Œãªã„ã‚ˆã†ã«ï¼‰ ---
try:
    import streamlit as st
except Exception:  # pragma: no cover
    import types as _t
    st = _t.SimpleNamespace(
        subheader=print, text_area=lambda *a, **k: "", button=lambda *a, **k: False,
        success=print, warning=print, error=print, info=print, caption=print, columns=lambda *a, **k: [None, None],
        write=print, checkbox=lambda *a, **k: False, color_picker=lambda *a, **k: "#000000", toast=print,
        divider=lambda *a, **k: None, markdown=print, selectbox=lambda *a, **k: None, rerun=lambda: None,
        metric=lambda *a, **k: None
    )

def _norm_hex(c: str, fallback: str) -> str:
    """#RRGGBB ã«æ­£è¦åŒ–ï¼ˆå¤±æ•—æ™‚ã¯ fallbackï¼‰"""
    if isinstance(c, str):
        c = c.strip()
        if len(c) == 7 and c.startswith("#"):
            try:
                int(c[1:], 16)
                return c.upper()
            except Exception:
                pass
    return fallback

def _get_session_palette() -> dict:
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸Šæ›¸ããƒ‘ãƒ¬ãƒƒãƒˆï¼ˆç„¡ã‘ã‚Œã°ç©ºï¼‰"""
    pal =  (st.session_state.get("alert_palette_overrides") or {}) if hasattr(st, "session_state") else {}
    return pal if isinstance(pal, dict) else {}

def _apply_session_palette(new_pal: dict) -> None:
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³é™å®šãƒ‘ãƒ¬ãƒƒãƒˆã‚’é©ç”¨ã—ã€ç›£æŸ»ã«è¨˜éŒ²"""
    st.session_state["alert_palette_overrides"] = new_pal
    W.emit("settings.palette.apply_session", level="INFO", feature="settings", payload={"overrides": new_pal})
    st.toast("ã‚¢ãƒ©ãƒ¼ãƒˆè‰²ã‚’ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é©ç”¨ã—ã¾ã—ãŸ", icon="ğŸ¨")

def _reset_session_palette() -> None:
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³é™å®šãƒ‘ãƒ¬ãƒƒãƒˆã‚’è§£é™¤ã—ã€ç›£æŸ»ã«è¨˜éŒ²"""
    if "alert_palette_overrides" in st.session_state:
        del st.session_state["alert_palette_overrides"]
    W.emit("settings.palette.reset_session", level="INFO", feature="settings", payload={})
    st.toast("ã‚¢ãƒ©ãƒ¼ãƒˆè‰²ã‚’æ—¢å®šã«æˆ»ã—ã¾ã—ãŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é©ç”¨è§£é™¤ï¼‰", icon="â†º")

def _toggle_demo_alerts():
    """ãƒ‡ãƒ¢ã‚¢ãƒ©ãƒ¼ãƒˆã®æŠ•å…¥/è§£é™¤ï¼ˆå³æ™‚åæ˜ ã®ãŸã‚ rerun ã‚‚è¡Œã†ï¼‰"""
    if st.session_state.get("demo_alerts"):
        st.session_state["_alerts"] = [
            {"level": "urgent", "label": "ç·Šæ€¥Y"},
            {"level": "crit",   "label": "é‡å¤§X"},
            {"level": "warn",   "label": "æ³¨æ„A"},
            {"level": "more",   "label": "+1"},
        ]
        W.emit("settings.demo_alerts.enable", level="INFO", feature="settings", payload={"count": 4})
        st.toast("ãƒ‡ãƒ¢ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ", icon="ğŸ””")
        st.rerun()  # ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒƒãƒ—ã‚’å³åæ˜ 
    else:
        st.session_state["_alerts"] = []
        W.emit("settings.demo_alerts.disable", level="INFO", feature="settings", payload={})
        st.toast("ãƒ‡ãƒ¢ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ", icon="ğŸ§¹")
        st.rerun()

# --- yaml ã¯ä»»æ„ï¼ˆç„¡ã‘ã‚Œã° JSON ã§ä»£æ›¿ï¼‰ ---
try:
    import yaml  # type: ignore
    def _to_text(obj: Any) -> str:
        return yaml.safe_dump(obj, sort_keys=False, allow_unicode=True)
    def _from_text(text: str) -> Any:
        return yaml.safe_load(text) if text.strip() else {}
except Exception:  # pragma: no cover
    def _to_text(obj: Any) -> str:
        return json.dumps(obj, ensure_ascii=False, indent=2)
    def _from_text(text: str) -> Any:
        return json.loads(text) if text.strip() else {}

# --- svc_settings ã® API ã‚’å¤šæ®µã§è§£æ±ºï¼ˆsettings é…ä¸‹ã® svc ã‚’å‚ç…§ï¼‰ ---
def _resolve_api() -> Tuple[Callable[[], Any], Callable[[Any], None]]:
    from importlib import import_module
    svc = import_module("btc_trade_system.features.settings.settings_svc")

    load_candidates = ["load_for_ui", "load", "load_monitoring", "read", "read_monitoring", "get_monitoring"]
    save_candidates = ["save_from_ui", "save", "save_monitoring", "write", "write_monitoring", "put_monitoring"]

    load_fn = next((getattr(svc, n) for n in load_candidates if callable(getattr(svc, n, None))), None)
    if load_fn is None:
        def _load_stub(): return {}
        load_fn = _load_stub

    save_fn = next((getattr(svc, n) for n in save_candidates if callable(getattr(svc, n, None))), None)
    if save_fn is None:
        def _save_stub(_obj: Any) -> None:
            raise RuntimeError("settings_svc ã«ä¿å­˜ç”¨APIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        save_fn = _save_stub

    return load_fn, save_fn

def render():
    # è¨­å®šã‚¿ãƒ–ã®ã‚¹ã‚³ãƒ¼ãƒ—ç”¨ãƒ©ãƒƒãƒ‘ï¼ˆCSSã¯ styles/settings.css ç®¡ç†ï¼‰
    st.markdown("<div class='settings-tab'>", unsafe_allow_html=True)

    st.subheader("è¨­å®šï¼ˆmonitoring.yamlï¼‰")

    # ---- ãƒ‡ãƒ¢ã‚¢ãƒ©ãƒ¼ãƒˆæŠ•å…¥ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºç¢ºèªç”¨ï¼‰ ----
    st.divider()
    st.checkbox("ãƒ‡ãƒ¢ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ•å…¥", key="demo_alerts", on_change=_toggle_demo_alerts)
    st.caption("â€» ãƒ˜ãƒƒãƒ€ãƒ¼å³ã®ãƒãƒƒãƒ—è¡¨ç¤ºãƒ»é…ç½®ã®ç¢ºèªç”¨é€”ã€‚ä¿å­˜ã¯è¡Œã„ã¾ã›ã‚“ã€‚")

    # ---- ã‚¢ãƒ©ãƒ¼ãƒˆè‰²ï¼ˆä»Šå›ã®ã¿é©ç”¨ï¼‰ ----
    st.subheader("ã‚¢ãƒ©ãƒ¼ãƒˆè‰²ï¼ˆä»Šå›ã®ã¿é©ç”¨ï¼‰")
    pal_now = _get_session_palette()
    defaults = {
        "warn":   {"fg": "#000000", "bg": "#FDE8C8"},
        "crit":   {"fg": "#FFFFFF", "bg": "#F9C8C8"},
        "urgent": {"fg": "#FFFFFF", "bg": "#FF6B6B"},
    }
    use = {
        k: {
            "fg": _norm_hex((pal_now.get(k, {}) or {}).get("fg", defaults[k]["fg"]), defaults[k]["fg"]),
            "bg": _norm_hex((pal_now.get(k, {}) or {}).get("bg", defaults[k]["bg"]), defaults[k]["bg"]),
        }
        for k in ["urgent", "crit", "warn"]  # è¡¨ç¤ºé †ï¼šç·Šæ€¥â†’é‡å¤§â†’æ³¨æ„
    }

    c_urgent, c_crit, c_warn = st.columns(3)
    with c_urgent:
        st.caption("ç·Šæ€¥")
        u_fg = st.color_picker("æ–‡å­—", use["urgent"]["fg"], key="pick_urgent_fg", label_visibility="collapsed")
        u_bg = st.color_picker("èƒŒæ™¯", use["urgent"]["bg"], key="pick_urgent_bg", label_visibility="collapsed")
    with c_crit:
        st.caption("é‡å¤§")
        c_fg = st.color_picker("æ–‡å­—", use["crit"]["fg"], key="pick_crit_fg", label_visibility="collapsed")
        c_bg = st.color_picker("èƒŒæ™¯", use["crit"]["bg"], key="pick_crit_bg", label_visibility="collapsed")
    with c_warn:
        st.caption("æ³¨æ„")
        w_fg = st.color_picker("æ–‡å­—", use["warn"]["fg"], key="pick_warn_fg", label_visibility="collapsed")
        w_bg = st.color_picker("èƒŒæ™¯", use["warn"]["bg"], key="pick_warn_bg", label_visibility="collapsed")

    c_apply, c_reset, c_save = st.columns([1, 1, 1])
    with c_apply:
        if st.button("é©ç”¨ï¼ˆä»Šå›ã®ã¿ï¼‰", use_container_width=True):
            _apply_session_palette({
                "warn":   {"fg": _norm_hex(w_fg, use["warn"]["fg"]),   "bg": _norm_hex(w_bg, use["warn"]["bg"])},
                "crit":   {"fg": _norm_hex(c_fg, use["crit"]["fg"]),   "bg": _norm_hex(c_bg, use["crit"]["bg"])},
                "urgent": {"fg": _norm_hex(u_fg, use["urgent"]["fg"]), "bg": _norm_hex(u_bg, use["urgent"]["bg"])},
            })
            st.rerun()
    with c_reset:
        if st.button("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ", use_container_width=True):
            _reset_session_palette()
            st.rerun()
    with c_save:
        if st.button("ä¿å­˜ï¼ˆbasic.yamlï¼‰", use_container_width=True):
            W.emit("settings.palette.save_click", level="INFO", feature="settings", payload={"note": "not_implemented_yet"})
            st.toast("ä¿å­˜ã¯æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã—ã¾ã™ï¼ˆä»Šå›ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³é©ç”¨ã®ã¿ï¼‰", icon="â„¹ï¸")

    # --- monitoring.yaml ã®ãƒ­ãƒ¼ãƒ‰/ä¿å­˜ API è§£æ±º ---
    load_fn, save_fn = _resolve_api()

    # èª­ã¿è¾¼ã¿
    try:
        cfg = load_fn()
    except Exception as e:
        st.warning(f"è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        cfg = {}

    # UIã§é¸ã‚“ã ç›£æŸ»ãƒ¢ãƒ¼ãƒ‰ã‚’ monitoring.yaml ã«å³ä¿å­˜ï¼ˆENVå„ªå…ˆã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ç¶­æŒï¼‰
    def _save_audit_mode_selected():
        try:
            sel = st.session_state.get("audit_mode_select", "PROD")
            obj = load_fn() or {}
            if not isinstance(obj, dict):
                obj = {}
            audit_block = obj.get("audit") if isinstance(obj.get("audit"), dict) else {}
            audit_block["mode"] = sel
            obj["audit"] = audit_block
            save_fn(obj)
            st.toast(f"ä¿å­˜ã—ã¾ã—ãŸï¼ˆaudit.mode = {sel}ï¼‰")
        except Exception as e:
            st.warning(f"ãƒ¢ãƒ¼ãƒ‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

    # ãƒ©ãƒƒãƒ‘ã‚’é–‰ã˜ã‚‹
    st.markdown("</div>", unsafe_allow_html=True)

    # --- é‹è»¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆUIå´ï¼‰ï¼† æœ‰åŠ¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆENV > UIï¼‰ã®è¡¨ç¤º ---
    modes = ["PROD", "DEBUG", "DIAG"]
    ui_mode = (isinstance(cfg, dict) and isinstance(cfg.get("audit"), dict) and cfg["audit"].get("mode")) or "PROD"
    env_mode = os.getenv("BTC_TS_MODE")
    effective_mode = (env_mode or ui_mode or "PROD").upper()

    st.caption("é‹è»¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆç›£æŸ»ã®å‡ºåŠ›é‡ï¼‰")
    c_mode, c_eff = st.columns([1, 1])
    with c_mode:
        st.selectbox(
            "UIã§è¨­å®šï¼ˆmonitoring.yaml ã® audit.mode ã«ä¿å­˜ï¼‰",
            modes,
            index=modes.index(ui_mode) if ui_mode in modes else 0,
            key="audit_mode_select",
            help="â€» å®Ÿéš›ã®å‡ºåŠ›é‡ã¯ç’°å¢ƒå¤‰æ•° BTC_TS_MODE ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆãã¡ã‚‰ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚",
            on_change=_save_audit_mode_selected,
        )
    with c_eff:
        st.write("**æœ‰åŠ¹ãƒ¢ãƒ¼ãƒ‰**ï¼ˆå„ªå…ˆåº¦: ENV > UIï¼‰")
        st.metric(label="audit mode", value=effective_mode)
        if env_mode:
            st.caption(f"ENV: BTC_TS_MODE={env_mode}")

    # YAML/JSON ç·¨é›†æ¬„
    text = _to_text(cfg if isinstance(cfg, (dict, list)) else (cfg or {}))
    text = st.text_area("è¨­å®šï¼ˆYAML / JSONï¼‰", text, height=360)

    c1, c2 = st.columns([1,1])
    with c1:
        if st.button("ä¿å­˜", use_container_width=True):
            try:
                obj = _from_text(text)
                if not isinstance(obj, dict):
                    obj = {}
                # UIã®é¸æŠå€¤ã‚’ audit.mode ã«åæ˜ ï¼ˆENV å„ªå…ˆã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å´ã§ç¶­æŒï¼‰
                sel = st.session_state.get("audit_mode_select", "PROD")
                audit_block = obj.get("audit") if isinstance(obj.get("audit"), dict) else {}
                audit_block["mode"] = sel
                obj["audit"] = audit_block
                save_fn(obj)
                st.success(f"ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆaudit.mode = {sel}ï¼‰")
            except Exception as e:
                st.error(f"ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    with c2:
        if st.button("å†èª­è¾¼", use_container_width=True):
            try:
                cfg2 = load_fn()
                st.info("èª­ã¿è¾¼ã¿å®Œäº†ã€‚ä¸‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ ã—ã¦ã„ã¾ã™ã€‚")
                st.write(cfg2)
            except Exception as e:
                st.error(f"å†èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
